##
##  Workarounds for bugs and temporary things
##

startup --host_jvm_args=-Xmx3072m # we need at least 3G to reliably build, the default is to use 1/4 of memory, which makes flaky on 8G boxes
common  --incompatible_package_name_is_a_function=false # https://github.com/protocolbuffers/protobuf/issues/5547

# enable https://github.com/google/googletest/pull/1653
common:build --define absl=1
common:test --test_env=GTEST_INSTALL_FAILURE_SIGNAL_HANDLER=1

##
##  Custom toolchain.
##
build --crosstool_top=@llvm_toolchain//:toolchain
test --crosstool_top=@llvm_toolchain//:toolchain

##
##  Common build options across all build configurations
##

# C / C++ Options
# Don't depend on system compiler
build --cxxopt=-std=c++17 --host_cxxopt=-std=c++17


# Developer laptops run skylake, devboxes run skylake-avx512
# however some AWS instances in our fleet still run Sandy Bridge (Skylake predecessor)
build --copt=-march=sandybridge
build --cxxopt=-march=sandybridge

build --copt=-fno-omit-frame-pointer
build --cxxopt=-fno-omit-frame-pointer

build --copt=-fstack-protector
build --cxxopt=-fstack-protector

build --copt=-Werror --copt=-Wimplicit-fallthrough
build --cxxopt=-Werror --cxxopt=-Wimplicit-fallthrough

build --host_cxxopt=-O1
build --host_copt=-O1
build --host_cxxopt=-DFORCE_DEBUG
build --host_copt=-DFORCE_DEBUG
build --host_cxxopt=-Wno-unused-variable --host_cxxopt=-Wno-overloaded-virtual --host_cxxopt=-Wno-unused-const-variable # ragel violates those and we want a silent build

# The MacOS CROSSTOOL in bazel defines _FORTIFY_SOURCE both on
# <command line>:1:9: and <built-in>:355:9: so sadly we turn them all off
build --copt=-Wno-macro-redefined
build --cxxopt=-Wno-macro-redefined

##
## debug configuration
##
build:dbg --copt=-O0
build:dbg --cxxopt=-O0
build:dbg --compilation_mode=dbg
build:dbg --config=debugsymbols
build:dbg --config=nopie

build:coverage --config=dbg
test:coverage --spawn_strategy=standalone

##
## Configurations used for releases
##
# release version: optimized, with debug symbols and version information
build:release-common --define release=true
build:release-common --define jemalloc=true
build:release-common --compilation_mode=opt
build:release-common --config=debugsymbols
build:release-common --config=nopie
build:release-common --stamp

# harden: mark relocation sections read-only
build:release-linux --linkopt=-Wl,-z,relro,-z,now
build:release-linux --config=lto-linux --config=release-common

build:release-mac --config=release-common

build:release-debug-linux --config=release-linux
build:release-debug-linux --config=forcedebug
build:release-debug-linux --config=dbg

build:release-debug-mac --config=release-mac
build:release-debug-mac --config=forcedebug
build:release-debug-mac --config=dbg

build:release-sanitized-linux --copt=-O2 --cxxopt=-O2
build:release-sanitized-linux --config=sanitize-linux
build:release-sanitized-linux --define jemalloc=false
build:release-sanitized-linux --config=debugsymbols
build:release-sanitized-linux --config=forcedebug

build:release-sanitized-mac --copt=-O2 --cxxopt=-O2
build:release-sanitized-mac --config=forcedebug
build:release-sanitized-mac --config=debugsymbols
build:release-sanitized-mac --config=sanitize-mac
build:release-sanitized-mac --define jemalloc=false

##
## Configuration used to to as much testing as possible in CI
##
build:test-sanitized-linux --config=release-sanitized-linux --config=dbg --nostamp --define release=false
test:test-sanitized-linux --config=release-sanitized-linux --config=dbg --nostamp --define release=false
test:test-sanitized-linux --test_env="UBSAN_OPTIONS=print_stacktrace=1"
test:test-sanitized-linux --test_env="ASAN_OPTIONS=detect_leaks=0"

build:test-sanitized-mac --config=release-sanitized-mac --config=dbg --nostamp --define release=false
test:test-sanitized-mac --config=release-sanitized-mac --config=dbg --nostamp --define release=false
test:test-sanitized-mac --test_env="UBSAN_OPTIONS=print_stacktrace=1"

build:buildfarm --curses=no
test:buildfarm --curses=no
test:buildfarm --test_output=errors
build:buildfarm-sanitized-linux --config=test-sanitized-linux --config=buildfarm
test:buildfarm-sanitized-linux --config=test-sanitized-linux --config=buildfarm
build:buildfarm-sanitized-mac --config=test-sanitized-mac --config=buildfarm
test:buildfarm-sanitized-mac --config=test-sanitized-mac --config=buildfarm

build:travis --config=test-sanitized-linux
build:travis --curses=no
test:travis --ram_utilization_factor=10
test:travis --test_strategy=standalone
test:travis --curses=no
test:travis --test_output=errors

##
## Shared fragments of configuration
##

# DEBUG_MODE is set by default for all builds except --config=release.
# Use this flag to set DEBUG_MODE even for --config=release.
build:forcedebug --copt=-DFORCE_DEBUG
build:forcedebug --cxxopt=-DFORCE_DEBUG

# LTO build. Much longer compilation time. Smaller size and better perf.
build:lto --copt=-flto=thin
build:lto --cxxopt=-flto=thin
build:lto --linkopt=-flto=thin
build:lto --config=nopie

## flags that substantially increase Clang&LLVMs ability to devirtualize calls
build:lto-linux --linkopt=-Wl,--icf=all
build:lto-linux --config=lto

# Used to build --stamp build that contains version and build time.
build --workspace_status_command=tools/buildstamp/get_workspace_status

# It's useful to be able to write `config_setting` rules for "this is
# an unsanitized build", but we can't express "copt does not contain
# -fsanitize". So we set this `--define` and unset it if we're using a
# sanitizer.
build --define unsanitized=true
# sanitize build: run with ASAN and UBSAN. Catches most memory and
# undefined-behavior errors, substantially larger and slower binary.
build:sanitize --config=asan --config=ubsan

build:asan --copt=-fsanitize=address --copt=-fsanitize-address-use-after-scope
build:asan --cxxopt=-fsanitize=address --cxxopt=-fsanitize-address-use-after-scope
build:asan --linkopt=-fsanitize=address --linkopt=-fsanitize-address-use-after-scope
build:asan --cxxopt=-DADDRESS_SANITIZER # used by abseil
build:asan --cxxopt=-DHAS_SANITIZER
build:asan --define unsanitized=false

build:ubsan --copt=-fsanitize=undefined --copt=-fno-sanitize-recover=undefined
build:ubsan --cxxopt=-fsanitize=undefined --copt=-fno-sanitize-recover=undefined
build:ubsan --linkopt=-fsanitize=undefined --copt=-fno-sanitize-recover=undefined
build:ubsan --define unsanitized=false
build:ubsan --cxxopt=-DHAS_SANITIZER

# Bazel links C++ files with $CC, not $CXX, this breaks UBSan
build:sanitize-linux --linkopt=external/llvm_toolchain/lib/clang/8.0.0/lib/linux/libclang_rt.asan_cxx-x86_64.a
test:sanitize-linux --linkopt=external/llvm_toolchain/lib/clang/8.0.0/lib/linux/libclang_rt.asan_cxx-x86_64.a
build:sanitize-linux --config=sanitize
test:sanitize-linux --config=sanitize

build:sanitize-mac --config=sanitize
test:sanitize-mac --config=sanitize

build:tsan --copt=-fsanitize=thread
build:tsan --cxxopt=-fsanitize=thread
build:tsan --linkopt=-fsanitize=thread

# Build optimized for executable size. Can be faster if size of executable code is a bottleneck.
build:size --linkopt=-Os --config=lto
build:size --copt=-Os --config=lto

### Debug symbols on OS X. ###
# From https://github.com/RobotLocomotion/drake/blob/master/tools/cc_toolchain/bazel.rc
# See https://github.com/bazelbuild/bazel/issues/2537
build:debugsymbols --copt=-g3 --copt=-fstandalone-debug --copt=-DDEBUG_SYMBOLS --copt=-glldb
build:debugsymbols --cxxopt=-g3 --cxxopt=-fstandalone-debug --cxxopt=-DDEBUG_SYMBOLS --cxxopt=-glldb
build:debugsymbols --linkopt=-g3 --linkopt=-fstandalone-debug --linkopt=-DDEBUG_SYMBOLS --linkopt=-glldb
build:debugsymbols --spawn_strategy=standalone
build:debugsymbols --genrule_strategy=standalone

build:nopie --linkopt=-fno-pie
build:nopie --copt=-fno-pie
build:nopie --cxxopt=-fno-pie

build --strip=never

# Enable nice UIs. Taken from bazel.rc of Bazel itself.
common --experimental_ui --experimental_ui_actions_shown 8
common --show_progress_rate_limit=0.25

##
## Fuzzing
##
build:fuzz --copt=-fsanitize=fuzzer --cxxopt=-fsanitize=fuzzer --linkopt=-fsanitize=fuzzer --config=asan
build:fuzz --config=forcedebug --config=debugsymbols
build:fuzz --copt=-DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION --cxxopt=-DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION

##
## Webasm config. Please use either of those depending on your platform
##
build:webasm-linux --crosstool_top=//tools/toolchain/webasm-linux --config=webasm
build:webasm-darwin --crosstool_top=//tools/toolchain/webasm-darwin --config=webasm

# common webasm config
# Use --cpu as a differentiator.
build:webasm --cpu=webasm --spawn_strategy=standalone --genrule_strategy=standalone --copt=-Oz --cxxopt=-Oz --linkopt=-Oz --copt=-DMDB_USE_ROBUST=0 --cxxopt=-DMDB_USE_ROBUST=0
build:webasm --define release=true
build:webasm --stamp
build:webasm --compilation_mode=opt
build:webasm --copt=-DNDEBUG --cxxopt=-DNDEBUG --linkopt=-DNDEBUG # for some reason emscripten doesn't pass those when -O2\-Oz are specified
build:webasm --copt=--llvm-lto --copt=3 --cxxopt=--llvm-lto --cxxopt=3 --linkopt=--llvm-lto --linkopt=3
# Specify a "sane" C++ toolchain for the host platform.
build:webasm --host_crosstool_top=@bazel_tools//tools/cpp:toolchain

##
## Stripe's ci passes --config=ci, we need it to exist
##
common:stripeci --config=ci
common:ci --color yes
