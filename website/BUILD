load("@aspect_bazel_lib//lib:write_source_files.bzl", "write_source_file")
load("@bazel_skylib//rules:diff_test.bzl", "diff_test")

sh_binary(
    name = "generate_cli_ref",
    srcs = ["scripts/generate_cli_ref.sh"],
    args = ["$(location //main:sorbet-orig)"],
    data = ["//main:sorbet-orig"],
)

cli_ref_md = "docs/cli-ref.md"
cli_ref_md_gen = "{}.gen".format(cli_ref_md)

genrule(
    name = "generate_cli_ref_md",
    outs = [cli_ref_md_gen],
    cmd = "$(location :generate_cli_ref) $(location //main:sorbet-orig) > $(location {})".format(cli_ref_md_gen),
    tools = [
        ":generate_cli_ref",
        "//main:sorbet-orig",
    ],
)

diff_test(
    name = "validate_cli_ref",
    failure_message = "\n\nThe `website/docs/cli-ref.md` doc is autogenerated.\nPlease run:\n    bazel run //website:update_cli_ref\nto update it.\n",
    file1 = cli_ref_md,
    file2 = ":generate_cli_ref_md",
)

write_source_file(
    name = "update_cli_ref",
    in_file = ":generate_cli_ref_md",
    out_file = cli_ref_md,
)
