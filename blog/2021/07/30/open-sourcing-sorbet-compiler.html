<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Sorbet Compiler: An experimental, ahead-of-time compiler for Ruby · Sorbet</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="For the past year, the [Sorbet](https://sorbet.org/) team has been working on an"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Sorbet Compiler: An experimental, ahead-of-time compiler for Ruby · Sorbet"/><meta property="og:type" content="website"/><meta property="og:url" content="https://sorbet.org/blog/2021/07/30/open-sourcing-sorbet-compiler"/><meta property="og:description" content="For the past year, the [Sorbet](https://sorbet.org/) team has been working on an"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/favicon.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://sorbet.org/blog/atom.xml" title="Sorbet Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://sorbet.org/blog/feed.xml" title="Sorbet Blog RSS Feed"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-119877071-2', 'auto');
              ga('send', 'pageview');
            </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/sorbet-logo-white-sparkles.svg" alt="Sorbet"/><h2 class="headerTitleWithLogo">Sorbet</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/adopting" target="_self">Get started</a></li><li class=""><a href="/docs/overview" target="_self">Docs</a></li><li class=""><a href="https://sorbet.run" target="_self">Try</a></li><li class=""><a href="/en/community" target="_self">Community</a></li><li class=""><a href="https://github.com/sorbet/sorbet" target="_self">GitHub</a></li><li class="siteNavGroupActive"><a href="/blog/" target="_self">Blog</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Recent Posts</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Recent Posts</h3><ul class=""><li class="navListItem"><a class="navItem" href="/blog/2022/07/27/srb-tapioca">Tapioca is the recommended way to generate RBIs for Sorbet</a></li><li class="navListItem"><a class="navItem" href="/blog/2022/01/06/open-sourcing-sorbet-vscode">Open-sourcing the Sorbet VS Code Extension</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/blog/2021/07/30/open-sourcing-sorbet-compiler">Sorbet Compiler: An experimental, ahead-of-time compiler for Ruby</a></li><li class="navListItem"><a class="navItem" href="/blog/2020/07/30/ruby-3-rbs-sorbet">Types in Ruby 3, RBS, and Sorbet</a></li><li class="navListItem"><a class="navItem" href="/blog/2019/12/20/announcing-sorbet-0.5">Announcing Sorbet 0.5</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer postContainer blogContainer"><div class="wrapper"><div class="lonePost"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle"><a href="/blog/2021/07/30/open-sourcing-sorbet-compiler">Sorbet Compiler: An experimental, ahead-of-time compiler for Ruby</a></h1><p class="post-meta">July 30, 2021</p><div class="authorBlock"></div></header><div><span><p>For the past year, the <a href="https://sorbet.org/">Sorbet</a> team has been working on an
experimental, ahead-of-time compiler for Ruby, powered by Sorbet and LLVM. Today
we’re sharing the source code for it. It lives alongside the existing code for
Sorbet on GitHub, mostly in the <code>compiler/</code> folder:</p>
<p>→ <a href="https://github.com/sorbet/sorbet/tree/master/compiler/">https://github.com/sorbet/sorbet/tree/master/compiler/</a></p>
<p>We want to be clear up front: the code is nowhere near ready for external use
right now, but we welcome you to read the code and give us feedback on our
approach!</p>
<p>We teased this a few weeks back in a tweet, which drew a fair bit of attention,
and also a lot of questions:</p>
<!--truncate-->
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">We&#39;re big believers in multi-year infrastructure bets. After a few years of Ruby infra work, our in-house Ruby compiler is now 22–170% faster than Ruby&#39;s default implementation for Stripe&#39;s production API traffic. If interested in working on such problems, we&#39;re hiring!</p>&mdash; Patrick Collison (@patrickc) <a href="https://twitter.com/patrickc/status/1410269843585069056?ref_src=twsrc%5Etfw">June 30, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>Before answering the questions raised in the above discussion, some disclaimers:</p>
<ul>
<li><p>If you’re an existing Sorbet user, nothing changes for you! You can continue
to use Sorbet to typecheck your Ruby codebases exactly as you do now. While
the Sorbet Compiler code lives in the Sorbet repo, it doesn’t change anything
about Sorbet, nor is it required to use Sorbet.</p></li>
<li><p>There are no Sorbet Compiler binary releases. If it works out, we may some day
publish pre-built binaries of the Sorbet Compiler, but right now we don’t have
any firm plans. We welcome you to read the source and try to compile it
yourself if you’re curious.</p></li>
<li><p>While we are using the Sorbet Compiler at Stripe in production, it should NOT
be considered “production ready.” We won’t prioritize fixing issues that don’t
also affect Stripe. It is an internal experiment developed in the open.</p></li>
</ul>
<p>With those disclaimers out of the way, let’s dive into the frequently asked
questions.</p>
<h2><a class="anchor" aria-hidden="true" id="whats-your-goal-in-open-sourcing-it-now"></a><a href="#whats-your-goal-in-open-sourcing-it-now" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What’s your goal in open sourcing it now?</h2>
<p>We have a few goals. The first handful are entirely pragmatic:</p>
<ul>
<li>Even though the Sorbet Compiler’s repo was private, we had already shared it
with a handful of companies and individuals, which was toilsome.</li>
<li>Sometimes improving the compiler requires improving Sorbet. Such changes will
only require one PR in one repo now.</li>
<li>The Sorbet Compiler depends on Sorbet’s internal data structures. Now that the
two repos are one, they can share internal data structures directly.</li>
<li>Much of the Bazel build and test infrastructure in the two repos was
duplicated, but can now be shared.</li>
</ul>
<p>Apart from these pragmatic considerations, we’re interested in gathering
feedback from the larger community on our approach. Feel free to read the source
code and <a href="https://sorbet.org/en/community">reach out to us</a> with what you have
to say.</p>
<h2><a class="anchor" aria-hidden="true" id="why-does-stripe-care-about-ruby-performance"></a><a href="#why-does-stripe-care-about-ruby-performance" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Why does Stripe care about Ruby performance?</h2>
<p>At Stripe, our primary product is an API. In an API,
<a href="https://blog.nelhage.com/post/reflections-on-performance/">latency is a feature</a>
just as much as what the API lets you do. Stripe is a users-first company, and
those users have asked for lower latency.</p>
<p>Improving latency involves doing one of two things:</p>
<ul>
<li>Spending less time doing IO (e.g. network and storage), or</li>
<li>Spending less time in compute (i.e., Ruby)</li>
</ul>
<p>Other teams at Stripe are tackling latency from the IO angle. In parallel, we’ve
been working on building a &quot;<a href="https://youtu.be/sT6VJkkhy0o?t=454">big hammer</a>&quot;
for improving Ruby compute performance.</p>
<h2><a class="anchor" aria-hidden="true" id="why-build-a-compiler"></a><a href="#why-build-a-compiler" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Why build a compiler…?</h2>
<p>This is our most popular question, and it comes in a bunch of different forms:</p>
<ul>
<li>Why build an ahead-of-time compiler, instead of a JIT compiler?</li>
<li>Why build a compiler, instead of using TruffleRuby or JRuby?</li>
<li>Why build a compiler, instead of making improvements to the Ruby VM?</li>
<li>Why build a compiler for Ruby, instead of using another language?</li>
</ul>
<p>You really want to know why, so here it is!</p>
<h3><a class="anchor" aria-hidden="true" id="why-build-an-ahead-of-time-compiler-instead-of-a-jit-compiler"></a><a href="#why-build-an-ahead-of-time-compiler-instead-of-a-jit-compiler" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Why build an ahead-of-time compiler, instead of a JIT compiler?</h3>
<p>There are a handful of reasons, which we’ll address one by one.</p>
<p>First, instead of having to ship an entire language runtime to production, with
an ahead-of-time compiler the compilation happens once in CI. We already ship
various generated code and data files in our deploy archives—compiled artifacts
fit seamlessly with our existing build pipelines. This also limits the blast
radius if something were to go wrong: if we need to “turn off” the compiler, we
just stop loading the compiled archives and let the Ruby VM run the original
source.</p>
<p>Another point: ahead-of-time compilers are conceptually simpler. When we kicked
off the Sorbet Compiler project, we estimated that it would take us less time to
build an ahead-of-time compiler delivering real-world performance improvements
than it would take to build a JIT that fulfills both our latency goals and
Stripe security requirements. As we’ll discuss below, our chosen implementation
strategy makes ahead-of-time compilation simpler and easier to roll out
gradually.</p>
<p>And finally, ahead-of-time compilation lets the project exploit type information
present statically, after Sorbet has type checked a project. While a JIT
observes the types at runtime to inform how it compiles the code, Sorbet already
has this information present (unless the code uses
<a href="https://sorbet.org/docs/untyped"><code>T.untyped</code></a>). Of course, this is a classic
tradeoff between a compiler and a JIT: sometimes the runtime type information is
actually better, because JITs can see through interfaces and polymorphism. We
don’t claim to have solved this tradeoff in the Sorbet Compiler, but Stripe’s
Ruby codebase is extensively covered by Sorbet, and is thus uniquely positioned
to make use of this static type information.</p>
<h3><a class="anchor" aria-hidden="true" id="why-build-a-compiler-instead-of-using-jruby-or-truffleruby"></a><a href="#why-build-a-compiler-instead-of-using-jruby-or-truffleruby" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Why build a compiler, instead of using JRuby or TruffleRuby?</h3>
<p>Many people in the Ruby community have found success replacing the Ruby VM with
either JRuby or TruffleRuby. JRuby makes it easy for Ruby to interoperate with
other JVM languages, and the same goes for TruffleRuby with GraalVM. Both claim
impressive performance improvements as well as enticing features like multicore,
shared-memory concurrency.</p>
<p>But nearly all of Stripe’s codebase is implemented in Ruby running on the
default Ruby VM (YARV). Not only did we not need Java VM-level interoperability,
choosing either alternative Ruby implementation would have made for a difficult
migration path. Stripe relies heavily on gems with native extensions, and as you
can imagine, a multi-million line Ruby codebase over time starts to depend on
Ruby-the-implementation, not just Ruby-the-language.</p>
<p>Another hurdle in switching to one of these implementations is that it has to be
done at a service boundary. We could have migrated some of Stripe’s smaller
services, but Stripe’s most latency-sensitive services are large, monolithic
Ruby services without clear breaking points. To adopt JRuby or TruffleRuby in
Stripe’s most important services, we’d have to be able to run all the code or
none of the code (at least on a subset of traffic).</p>
<p>Below we’ll talk below the implementation of the Sorbet Compiler, which solves
for this situation in a couple of ways:</p>
<ol>
<li><p>The Sorbet compiler targets Ruby native extensions, which trivially
interoperate with all other Ruby code. We don’t have to give up the Ruby VM
(quirks and all), and can continue to use all our existing gems and native
extensions.</p></li>
<li><p>Because it compiles to native extensions, we can enable the compiler at the
source file level instead of the service level. While we iron out the bugs in
our compiler and adopt it in production, we can carve out arbitrarily large
or small swaths of Stripe’s codebase to experiment with.</p></li>
</ol>
<h3><a class="anchor" aria-hidden="true" id="why-build-a-compiler-instead-of-making-improvements-to-the-ruby-vm"></a><a href="#why-build-a-compiler-instead-of-making-improvements-to-the-ruby-vm" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Why build a compiler, instead of making improvements to the Ruby VM?</h3>
<p>Another way of phrasing this question: are you going to upstream your changes to
the Ruby VM?</p>
<p>Ruby is fundamentally an interpreted language. Apart from maybe having a CI step
to pre-download third-party gems, many Ruby projects do not have any sort of
build step—the project’s Ruby source code is meant to run unprocessed by the
Ruby VM.</p>
<p>By contrast, our hypothesis was that we could deliver substantial performance
improvements by paying the cost of a one-time compilation step. Stripe already
has an extensive Ruby build pipeline, so this cost is minor.</p>
<p>And as mentioned above, the Sorbet Compiler relies entirely on Sorbet.
Specifically: it <strong>cannot</strong> work in a project that has not already adopted
Sorbet. The Ruby maintainers have made it very clear that they do not want to
force static typing on all users of the language, so there’s no place for the
Sorbet Compiler upstream.</p>
<h3><a class="anchor" aria-hidden="true" id="why-build-a-compiler-for-ruby-instead-of-using-another-language"></a><a href="#why-build-a-compiler-for-ruby-instead-of-using-another-language" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Why build a compiler for Ruby, instead of using another language?</h3>
<p>Great question, and the answer is: at Stripe we’re doing both!</p>
<p>A handful of teams at Stripe urgently need their code to run faster. Maybe a
team’s highest priority is improving latency in a small service with clear
boundaries. Or maybe a team is starting a greenfield project and anticipates
performance bottlenecks. Teams at Stripe have the choice between Ruby, Java, and
Go to build services in, depending on their needs.</p>
<p>But Stripe’s existing Ruby codebase is many millions of lines, and implements
Stripe’s most business-critical workloads. Even if we wanted to get rid of Ruby
(remember: many people value the unique expressiveness of Ruby!), it would take
a long time to rewrite all of Stripe’s Ruby code into another language.</p>
<p>As teams rewrite or build smaller projects in other languages, our team has been
working to tackle the elephant in the room: the millions of lines of existing
Ruby code powering Stripe’s core products.</p>
<h2><a class="anchor" aria-hidden="true" id="how-does-it-work"></a><a href="#how-does-it-work" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How does it work?</h2>
<p>The Sorbet Compiler is an ahead-of-time compiler for Ruby codebases that use
Sorbet, powered by LLVM and the existing Ruby VM. The high level technique looks
like this:</p>
<p><img src="/img/sorbet-compiler-high-level.png" alt=""></p>
<p>There are two phases: what happens in CI (to compile the code), and what happens
in production (to run the code).</p>
<p>When compiling the code, we start with normal <code>*.rb</code> source files, feeding them
to Sorbet to be typechecked. The output of type checking is a custom
type-annotated intermediate representation (IR), which the Sorbet Compiler
consumes to generate LLVM IR. LLVM takes this IR and generates native shared
object (<code>*.so</code>) files.</p>
<p>These shared objects are actually valid Ruby native extensions, conforming to
and using the same APIs as gems which include native extensions use. Thus, the
compiled artifacts use the same object model and runtime representation that all
other Ruby code uses!</p>
<p>The Ruby VM exposes quite an extensive set of APIs to extension authors, which
are sufficient to call back into the Ruby VM when a faster compilation strategy
doesn’t exist for a particular language feature. We might write more in the
future about how specifically we go from Sorbet’s typed IR to Ruby native
extensions, but this means that there is very little the Sorbet Compiler <em>can’t</em>
handle.</p>
<p>The decision to compile or not compile a file is made by adding a
<code># compiled: true</code> or <code># compiled: false</code> comment to the top of a Ruby source
file. If a file is compiled, the compiled artifact is bundled into a service’s
deploy archive like all other Ruby and data files.</p>
<p>At runtime, a small support module monkeypatches <code>require_relative</code> to skip
requiring the original <code>*.rb</code> file and instead require the newly compiled <code>*.so</code>
file if possible. Since these compiled artifacts are Ruby native extensions,
they can define classes, modules, and methods just the same as if a Ruby file
had been required.</p>
<p>Architected this way, the Sorbet Compiler turns Ruby into a language for writing
Ruby native extensions! Instead of having to write C, C++, Rust, or some other
compiled language to write native extensions, people can continue to write Ruby
but gain the benefits of native compiled speeds.</p>
<h2><a class="anchor" aria-hidden="true" id="how-fast-is-it"></a><a href="#how-fast-is-it" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How fast is it?</h2>
<p>We’re still very early on in the project, but we’re encouraged by our initial
results. We’ve been running the Sorbet Compiler in production at Stripe for
about a year, and as the tweet above mentioned, we’re finally starting to see
the payoff, with varying results depending on the workload.</p>
<p>That being said, we don’t have much more to share about performance right now.
We measure ourselves not against synthetic benchmarks, but against real-world
Stripe workloads, which are not public. We have some synthetic benchmarks
checked into the source repository, but none of these are representative and
mostly serve to help us debug and minimize performance problems we’ve seen in
the wild.</p>
<p>If you have a production workload you’d like to try the Sorbet Compiler on feel
free to take the source code and get it running your benchmark (of course: a
pre-requisite will be getting the benchmark to typecheck with Sorbet). Expect
hiccups and maybe even show-stopping bugs, as we have not tested the compiler in
environments that differ from Stripe’s internal production environment. If you
do try things out, feel free to let us know!</p>
<h2><a class="anchor" aria-hidden="true" id="whats-next"></a><a href="#whats-next" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What’s next?</h2>
<p>Over the next six months we’re going to be heads down focusing on making the
Sorbet Compiler perform even better on real-world code at Stripe. We’re excited
to share more with you once we’ve made more progress!</p>
<p>To get in touch with us, find us on our Sorbet Slack:</p>
<p>→ <a href="https://sorbet.org/slack">https://sorbet.org/slack</a></p>
<p>Thanks!<br>
— The Sorbet team</p>
</span></div></div><div class="blogSocialSection"></div></div><div class="blog-recent"><a class="button" href="/blog/">Recent Posts</a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#whats-your-goal-in-open-sourcing-it-now">What's your goal in open sourcing it now?</a></li><li><a href="#why-does-stripe-care-about-ruby-performance">Why does Stripe care about Ruby performance?</a></li><li><a href="#why-build-a-compiler">Why build a compiler…?</a><ul class="toc-headings"><li><a href="#why-build-an-ahead-of-time-compiler-instead-of-a-jit-compiler">Why build an ahead-of-time compiler, instead of a JIT compiler?</a></li><li><a href="#why-build-a-compiler-instead-of-using-jruby-or-truffleruby">Why build a compiler, instead of using JRuby or TruffleRuby?</a></li><li><a href="#why-build-a-compiler-instead-of-making-improvements-to-the-ruby-vm">Why build a compiler, instead of making improvements to the Ruby VM?</a></li><li><a href="#why-build-a-compiler-for-ruby-instead-of-using-another-language">Why build a compiler for Ruby, instead of using another language?</a></li></ul></li><li><a href="#how-does-it-work">How does it work?</a></li><li><a href="#how-fast-is-it">How fast is it?</a></li><li><a href="#whats-next">What's next?</a></li></ul></nav></div><footer class="nav-footer" id="footer"><div class="wrapper"><p class="footer"><svg width="99" height="28" viewBox="0 0 99 28" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.98432 20H6.27432C8.44932 20 9.81432 18.905 9.81432 17.03C9.81432 15.665 9.00432 14.72 7.78932 14.39C8.61432 14.105 9.45432 13.415 9.45432 12.035C9.45432 10.235 8.23932 9.23 5.95932 9.23H1.98432V20ZM3.37932 13.85V10.445H5.83932C7.27932 10.445 8.07432 11 8.07432 12.155C8.07432 13.295 7.27932 13.85 5.83932 13.85H3.37932ZM3.37932 15.08H6.21432C7.65432 15.08 8.43432 15.83 8.43432 16.925C8.43432 18.035 7.65432 18.785 6.21432 18.785H3.37932V15.08ZM18.0294 12.155H16.6794V16.88C16.6794 18.185 15.6894 18.92 14.7144 18.92C13.5594 18.92 13.0794 18.17 13.0794 17.06V12.155H11.7294V17.345C11.7294 19.01 12.6744 20.165 14.3544 20.165C15.4644 20.165 16.2294 19.58 16.6794 18.92V20H18.0294V12.155ZM20.5112 10.79H21.9812V9.23H20.5112V10.79ZM21.9212 12.155H20.5712V20H21.9212V12.155ZM25.8247 9.23H24.4747V20H25.8247V9.23ZM28.5882 18.125C28.5882 19.625 29.3532 20.075 30.6882 20.075C31.1382 20.075 31.5282 20.03 31.8732 19.955V18.8C31.5582 18.875 31.3332 18.89 31.0182 18.89C30.3282 18.89 29.9232 18.74 29.9232 17.915V13.31H31.7082V12.155H29.9232V9.86H28.5882V12.155H27.3732V13.31H28.5882V18.125ZM41.0199 20.165C43.1949 20.165 44.4399 18.305 44.4399 16.085C44.4399 13.85 43.1949 12.005 41.0199 12.005C39.9249 12.005 39.0549 12.53 38.5899 13.295V9.23H37.2399V20H38.5899V18.86C39.0549 19.64 39.9249 20.165 41.0199 20.165ZM38.5599 15.815C38.5599 13.985 39.6699 13.19 40.7799 13.19C42.2499 13.19 43.0749 14.39 43.0749 16.085C43.0749 17.765 42.2499 18.98 40.7799 18.98C39.6699 18.98 38.5599 18.17 38.5599 16.37V15.815ZM49.1804 20.855L52.5554 12.155H51.1454L48.9704 18.155L46.7654 12.155H45.3404L48.2504 19.715L47.8754 20.645C47.5604 21.425 47.2454 21.635 46.6604 21.635C46.4354 21.635 46.2704 21.62 46.0154 21.56V22.73C46.2554 22.775 46.4204 22.79 46.7504 22.79C48.1154 22.79 48.7304 22.04 49.1804 20.855Z" fill="white"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M98.7993 15.7838C98.7993 12.8786 97.3871 10.5862 94.688 10.5862C91.9774 10.5862 90.3374 12.8786 90.3374 15.7611C90.3374 19.177 92.2735 20.9019 95.0524 20.9019C96.4077 20.9019 97.4327 20.5955 98.2071 20.1643V17.8946C97.4327 18.2804 96.5443 18.5188 95.4168 18.5188C94.3121 18.5188 93.3327 18.1329 93.2074 16.7938H98.7766C98.7766 16.6463 98.7993 16.0561 98.7993 15.7838ZM93.1732 14.7057C93.1732 13.4233 93.9591 12.8899 94.6766 12.8899C95.3713 12.8899 96.1116 13.4233 96.1116 14.7057H93.1732Z" fill="white"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M85.9413 10.5862C84.8251 10.5862 84.1076 11.1082 83.709 11.4714L83.561 10.7678H81.0554V24.0001L83.9026 23.3986L83.914 20.187C84.324 20.482 84.9276 20.9019 85.9299 20.9019C87.9685 20.9019 89.8249 19.2678 89.8249 15.6703C89.8135 12.3792 87.9343 10.5862 85.9413 10.5862ZM85.2579 18.4053C84.586 18.4053 84.1874 18.167 83.914 17.8719L83.9026 13.6616C84.1988 13.3325 84.6088 13.1055 85.2579 13.1055C86.2943 13.1055 87.0118 14.2631 87.0118 15.7497C87.0118 17.2704 86.3057 18.4053 85.2579 18.4053Z" fill="white"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M77.1377 9.91656L79.9963 9.30374V7L77.1377 7.60147V9.91656Z" fill="white"></path><path d="M79.9963 10.7791H77.1377V20.709H79.9963V10.7791Z" fill="white"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M74.074 11.6187L73.8918 10.7789H71.4318V20.7088H74.279V13.9792C74.9509 13.1054 76.0898 13.2642 76.4429 13.3891V10.7789C76.0784 10.6427 74.7459 10.3931 74.074 11.6187Z" fill="white"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M68.3796 8.31641L65.6007 8.90653L65.5894 17.9966C65.5894 19.6762 66.8535 20.9132 68.5391 20.9132C69.473 20.9132 70.1563 20.743 70.5321 20.5387V18.235C70.1677 18.3825 68.3682 18.9045 68.3682 17.225V13.1962H70.5321V10.779H68.3682L68.3796 8.31641Z" fill="white"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M60.6807 13.6616C60.6807 13.219 61.0452 13.0488 61.6488 13.0488C62.5143 13.0488 63.6076 13.3098 64.4732 13.7751V11.1082C63.5279 10.7337 62.594 10.5862 61.6488 10.5862C59.3368 10.5862 57.7993 11.7891 57.7993 13.7978C57.7993 16.93 62.1271 16.4306 62.1271 17.7811C62.1271 18.3031 61.6715 18.4734 61.0338 18.4734C60.0885 18.4734 58.8813 18.0875 57.9246 17.5655V20.2664C58.9838 20.7204 60.0543 20.9133 61.0338 20.9133C63.4026 20.9133 65.0313 19.7444 65.0313 17.713C65.0199 14.3312 60.6807 14.9326 60.6807 13.6616Z" fill="white"></path></svg><a href="/docs/adopting">Get started</a> · <a href="/docs/overview">Docs</a> · <a href="https://sorbet.run">Try</a> · <a href="/en/community">Community</a> · <a href="/blog">Blog</a> · <a href="https://twitter.com/sorbet_ruby">Twitter</a></p></div></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                appId: 'ZYWC6Z01G8',
                apiKey: 'b05a65e9f8d9f50dc4ec3241db8836c4',
                indexName: 'stripe_sorbet',
                inputSelector: '#search_input_react',
                algoliaOptions: {}
              });
            </script></body></html>