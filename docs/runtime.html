<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Enabling Runtime Checks · Sorbet</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="As we&#x27;ve mentioned before, Sorbet is a [gradual](/docs/gradual) system: it can be turned on and off at will. This means the predictions Sorbet makes statically can be wrong."/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Enabling Runtime Checks · Sorbet"/><meta property="og:type" content="website"/><meta property="og:url" content="https://sorbet.org/"/><meta property="og:description" content="As we&#x27;ve mentioned before, Sorbet is a [gradual](/docs/gradual) system: it can be turned on and off at will. This means the predictions Sorbet makes statically can be wrong."/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/favicon.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://sorbet.org/blog/atom.xml" title="Sorbet Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://sorbet.org/blog/feed.xml" title="Sorbet Blog RSS Feed"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-5H7PQ9Z8KF"></script><script>
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments); }
              gtag('js', new Date());
              gtag('config', 'G-5H7PQ9Z8KF');
            </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/sorbet-logo-white-sparkles.svg" alt="Sorbet"/><h2 class="headerTitleWithLogo">Sorbet</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/adopting" target="_self">Get started</a></li><li class="siteNavGroupActive"><a href="/docs/overview" target="_self">Docs</a></li><li class=""><a href="https://sorbet.run" target="_self">Try</a></li><li class=""><a href="/en/community" target="_self">Community</a></li><li class=""><a href="https://github.com/sorbet/sorbet" target="_self">GitHub</a></li><li class=""><a href="/blog/" target="_self">Blog</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Static &amp; Runtime</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Getting Started</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/overview">Overview</a></li><li class="navListItem"><a class="navItem" href="/docs/adopting">Adopting Sorbet</a></li><li class="navListItem"><a class="navItem" href="/docs/metrics">Tracking Adoption</a></li><li class="navListItem"><a class="navItem" href="/docs/quickref">Quick Reference</a></li><li class="navListItem"><a class="navItem" href="/docs/vscode">Visual Studio Code</a></li><li class="navListItem"><a class="navItem" href="/docs/from-typescript">TypeScript ↔ Sorbet</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Static &amp; Runtime</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/gradual">Gradual Type Checking</a></li><li class="navListItem"><a class="navItem" href="/docs/static">Enabling Static Checks</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/runtime">Enabling Runtime Checks</a></li><li class="navListItem"><a class="navItem" href="/docs/rbi">RBI Files</a></li><li class="navListItem"><a class="navItem" href="/docs/cli">CLI Quickstart</a></li><li class="navListItem"><a class="navItem" href="/docs/cli-ref">CLI Reference</a></li><li class="navListItem"><a class="navItem" href="/docs/tconfiguration">Runtime Configuration</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Troubleshooting</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/troubleshooting">Troubleshooting</a></li><li class="navListItem"><a class="navItem" href="/docs/why-type-annotations">Why type annotations?</a></li><li class="navListItem"><a class="navItem" href="/docs/faq">FAQ</a></li><li class="navListItem"><a class="navItem" href="/docs/error-reference">Error Reference</a></li><li class="navListItem"><a class="navItem" href="/docs/unsupported">Unsupported Ruby Features</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Type System</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/sigs">sig</a></li><li class="navListItem"><a class="navItem" href="/docs/type-annotations">Type Annotations (non-sig)</a></li><li class="navListItem"><a class="navItem" href="/docs/type-assertions">T.let, T.cast, T.must, T.bind</a></li><li class="navListItem"><a class="navItem" href="/docs/class-types">Class Types (Integer, String)</a></li><li class="navListItem"><a class="navItem" href="/docs/stdlib-generics">Arrays &amp; Hashes</a></li><li class="navListItem"><a class="navItem" href="/docs/nilable-types">Nilable Types (T.nilable)</a></li><li class="navListItem"><a class="navItem" href="/docs/union-types">Union Types (T.any)</a></li><li class="navListItem"><a class="navItem" href="/docs/flow-sensitive">Flow-Sensitivity (is_a?, nil?)</a></li><li class="navListItem"><a class="navItem" href="/docs/type-aliases">T.type_alias</a></li><li class="navListItem"><a class="navItem" href="/docs/exhaustiveness">Exhaustiveness (T.absurd)</a></li><li class="navListItem"><a class="navItem" href="/docs/tstruct">T::Struct</a></li><li class="navListItem"><a class="navItem" href="/docs/tenum">T::Enum</a></li><li class="navListItem"><a class="navItem" href="/docs/untyped">T.untyped</a></li><li class="navListItem"><a class="navItem" href="/docs/procs">Blocks, Procs, &amp; Lambdas</a></li><li class="navListItem"><a class="navItem" href="/docs/abstract">Abstract Classes &amp; Interfaces</a></li><li class="navListItem"><a class="navItem" href="/docs/final">Final Methods &amp; Classes</a></li><li class="navListItem"><a class="navItem" href="/docs/override-checking">Override Checking</a></li><li class="navListItem"><a class="navItem" href="/docs/sealed">Sealed Classes</a></li><li class="navListItem"><a class="navItem" href="/docs/class-of">T.class_of</a></li><li class="navListItem"><a class="navItem" href="/docs/self-type">T.self_type</a></li><li class="navListItem"><a class="navItem" href="/docs/noreturn">T.noreturn</a></li><li class="navListItem"><a class="navItem" href="/docs/anything">T.anything</a></li><li class="navListItem"><a class="navItem" href="/docs/attached-class">T.attached_class</a></li><li class="navListItem"><a class="navItem" href="/docs/intersection-types">Intersection Types (T.all)</a></li><li class="navListItem"><a class="navItem" href="/docs/generics">Generics</a></li><li class="navListItem"><a class="navItem" href="/docs/non-forcing-constants">T::NonForcingConstants</a></li><li class="navListItem"><a class="navItem" href="/docs/strong">Banning untyped</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Editor Features</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/lsp">Language Server (LSP)</a></li><li class="navListItem"><a class="navItem" href="/docs/server-status">Server Status</a></li><li class="navListItem"><a class="navItem" href="/docs/lsp-typed-level">LSP &amp; Typed Level</a></li><li class="navListItem"><a class="navItem" href="/docs/go-to-def">Go to Definition</a></li><li class="navListItem"><a class="navItem" href="/docs/hover">Hover</a></li><li class="navListItem"><a class="navItem" href="/docs/autocompletion">Autocompletion</a></li><li class="navListItem"><a class="navItem" href="/docs/references">Find All References</a></li><li class="navListItem"><a class="navItem" href="/docs/code-actions">Code Actions</a></li><li class="navListItem"><a class="navItem" href="/docs/outline">Outline &amp; Document Symbols</a></li><li class="navListItem"><a class="navItem" href="/docs/doc-comments">Documentation Comments</a></li><li class="navListItem"><a class="navItem" href="/docs/sig-suggestion">Suggesting sigs</a></li><li class="navListItem"><a class="navItem" href="/docs/highlight-untyped">Highlighting untyped</a></li><li class="navListItem"><a class="navItem" href="/docs/sorbet-uris">sorbet: URIs</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Experimental Features</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/tuples">Tuples</a></li><li class="navListItem"><a class="navItem" href="/docs/shapes">Shapes</a></li><li class="navListItem"><a class="navItem" href="/docs/overloads">Overloads</a></li><li class="navListItem"><a class="navItem" href="/docs/requires-ancestor">Requiring Ancestors</a></li><li class="navListItem"><a class="navItem" href="/docs/rbs-support">RBS Comments</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://github.com/sorbet/sorbet/edit/master/website/docs/runtime.md" target="_blank" rel="noreferrer noopener">Edit</a><h1 id="__docusaurus" class="postHeaderTitle">Enabling Runtime Checks</h1></header><article><div><span><p>As we’ve mentioned before, Sorbet is a <a href="/docs/gradual">gradual</a> system: it can be turned on and off at will. This means the predictions Sorbet makes statically can be wrong.</p>
<p>That’s why Sorbet also uses <strong>runtime checks</strong>: even if a static prediction was wrong, it will get checked during runtime, making things fail loudly and immediately, rather than silently and after the fact.</p>
<p>In this doc we’ll answer:</p>
<ul>
<li>What’s the runtime effect of adding a <code>sig</code> to a method?</li>
<li>Why do we want to have a runtime effect?</li>
<li>What are our options if we don’t want <code>sig</code>s to affect the runtime?</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="runtime-checked-sigs"></a><a href="#runtime-checked-sigs" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Runtime-checked <code>sig</code>s</h2>
<p>Adding a method signature opts that method into runtime typechecks (in addition to opting it into <a href="/docs/static">more static checks</a>). In this sense, <code>sorbet-runtime</code> is similar to libraries for adding runtime contracts.</p>
<p>Concretely, adding a <code>sig</code> wraps the method defined beneath it in a new method that:</p>
<ul>
<li>validates the types of arguments passed in against the types in the <code>sig</code></li>
<li>calls the original method</li>
<li>validates the return type of the original method against what was declared</li>
<li>returns what the original method returned<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></li>
</ul>
<!-- prettier-ignore-start -->
<!-- prettier-ignore-end -->
<p>For example:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-keyword">require</span> <span class="hljs-string">'sorbet-runtime'</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Example</span></span>
  extend T::Sig

  sig { params(<span class="hljs-symbol">x:</span> Integer).returns(String) }
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">main</span><span class="hljs-params">(x)</span></span>
    <span class="hljs-string">"Passed: <span class="hljs-subst">#{x.to_s}</span>"</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

Example.main([]) <span class="hljs-comment"># passing an Array!</span>
</code></pre>
<pre><code class="hljs css language-shell">❯ ruby example.rb
...
Parameter 'x': Expected type Integer, got type Array with unprintable value (TypeError)
Caller: example.rb:11
Definition: example.rb:6
...
</code></pre>
<p>In this small example, we have a <code>main</code> method defined to take an Integer, but we’re passing an Array at the call site. When we run <code>ruby</code> on our example file, sorbet-runtime raises an exception because the signature was violated.</p>
<h2><a class="anchor" aria-hidden="true" id="why-have-runtime-checks"></a><a href="#why-have-runtime-checks" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Why have runtime checks?</h2>
<p>Runtime checks have been invaluable when developing Sorbet and rolling it out in large Ruby codebases like Stripe’s. Type annotations in a codebase are near useless if developers don’t trust them (consider how often YARD annotations fall out of sync with the code… 😰).</p>
<p>Adding a <code>sig</code> to a method is only as good as the predictions it lets Sorbet make about a codebase. Wrong sigs are actively harmful. Specifically, when <code>sig</code>s in our codebase are wrong:</p>
<ul>
<li>we can’t use them to find code to refactor. Sorbet will think some code paths can never be reached when they actually can.</li>
<li>they’re effectively as good as out-of-date documentation, with little added benefit over just comments.</li>
<li>we could never use them to make Ruby code run faster. In the future, we hope to use Sorbet types to make Ruby faster, but <code>sig</code>s that lie will actually make code <em>slower</em> than no types at all.</li>
</ul>
<p>By leveraging runtime checks, we can gain lots of confidence and trust in our type annotations:</p>
<ul>
<li>Automated test runs become tests of our type annotations!</li>
<li>Our production observability and monitoring catch bad sigs <strong>early</strong>, before they propagate false assumptions throughout a codebase.</li>
</ul>
<p>To drive these points home, let’s look at a concrete example:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-comment"># typed: true</span>
<span class="hljs-keyword">require</span> <span class="hljs-string">'sorbet-runtime'</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Example</span></span>
  extend T::Sig

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">some_untyped_method</span></span>
    <span class="hljs-literal">nil</span>
  <span class="hljs-keyword">end</span>

  sig { params(<span class="hljs-symbol">x:</span> Integer).returns(Integer) }
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">add_one</span><span class="hljs-params">(x)</span></span>
    x + <span class="hljs-number">1</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

Example.add_one(Example.some_untyped_method)
</code></pre>
<p><a href="https://sorbet.run/#%23%20typed%3A%20true%0Arequire%20'sorbet-runtime'%0A%0Aclass%20Example%0A%20%20extend%20T%3A%3ASig%0A%0A%20%20def%20self.some_untyped_method%0A%20%20%20%20nil%0A%20%20end%0A%0A%20%20sig%20%7Bparams(x%3A%20Integer).returns(Integer)%7D%0A%20%20def%20self.add_one(x)%0A%20%20%20%20x%20%2B%201%0A%20%20end%0Aend%0A%0AExample.add_one(Example.some_untyped_method)">→ View on sorbet.run</a></p>
<p>In this example, <code>srb tc</code> reports that there were <strong>no errors statically</strong>. But if we were to run this code with <code>ruby</code>, <code>some_untyped_method</code> would return <code>nil</code>, we’d try to add <code>1</code> to it, and Ruby would raise a NoMethodError for <code>+</code>. By adding a <code>sig</code> to <code>add_one</code>, the Sorbet runtime will raise an exception before even starting to execute the method. This makes typing errors from untyped code manifest early and loudly and right at the source, rather than silently, long after a sig was added, and far removed from this line of code.</p>
<p>Most people are <em>either</em> familiar with a completely typed language (Java, Go, etc.) or a completely untyped language like Ruby; a <a href="/docs/gradual">gradual type system</a> can be very foreign at first. Including these runtime checks by default protects typed code from untyped code, making it easier to drive adoption of types in the long run.</p>
<h2><a class="anchor" aria-hidden="true" id="changing-the-runtime-behavior"></a><a href="#changing-the-runtime-behavior" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Changing the runtime behavior</h2>
<p>While having runtime checks is the default, it’s possible to change the behavior of the runtime system via configuration settings. These configuration settings live in under the <code>T::Configuration</code> module within the <code>sorbet-runtime</code> gem.</p>
<p>There are two main ways to change Sorbet’s runtime:</p>
<ul>
<li><p><strong>When</strong> the runtime checks fail, what to do in response.</p>
<p>To change this, we use <code>.on_failure</code> in a method signature.</p></li>
<li><p><strong>Whether</strong> the runtime checks run in the first place.</p>
<p>To change this, we use <code>.checked</code> in a method signature.</p></li>
</ul>
<p>In the next sections, we’ll give some examples of how to use both.</p>
<h2><a class="anchor" aria-hidden="true" id="on_failure-changing-what-happens-on-runtime-errors"></a><a href="#on_failure-changing-what-happens-on-runtime-errors" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>.on_failure</code>: Changing what happens on runtime errors</h2>
<p>By adding <code>.on_failure(...)</code> to a sig and registering a <code>T::Configuration</code> callback, we can change what happens when a sig check fails. For example:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-keyword">require</span> <span class="hljs-string">'sorbet-runtime'</span>

<span class="hljs-comment"># (1) Register call_validation_error_handler callback.</span>
<span class="hljs-comment"># This runs every time a method with a sig fails to type check at runtime.</span>
T::Configuration.call_validation_error_handler = lambda <span class="hljs-keyword">do</span> <span class="hljs-params">|signature, opts|</span>
  <span class="hljs-comment">#                                                       ┌──┐</span>
  <span class="hljs-keyword">if</span> signature&amp;.on_failure &amp;&amp; signature&amp;.on_failure[<span class="hljs-number">0</span>] == <span class="hljs-symbol">:log</span>
    puts opts[<span class="hljs-symbol">:pretty_message</span>]
  <span class="hljs-keyword">else</span>
    raise TypeError.new(opts[<span class="hljs-symbol">:pretty_message</span>])
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span></span>
  extend T::Sig

  <span class="hljs-comment"># (2) Use .on_failure in the sig for a method</span>
  <span class="hljs-comment">#                                       ┌───────────────┐</span>
  sig { params(<span class="hljs-symbol">argv:</span> T::Array[String]).void.on_failure(<span class="hljs-symbol">:log</span>) }
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">main</span><span class="hljs-params">(argv)</span></span>
    puts argv
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-comment"># (3) When we call main incorrectly, it will print</span>
<span class="hljs-comment"># with puts instead of raise an exception.</span>
Main.main(<span class="hljs-number">42</span>)

<span class="hljs-comment"># Output:</span>
<span class="hljs-comment"># ❯ ruby example.rb</span>
<span class="hljs-comment"># Parameter 'argv': Expected type T::Array[String], got type Integer with value 42</span>
<span class="hljs-comment"># Caller: example.rb:25</span>
<span class="hljs-comment"># Definition: example.rb:18</span>
<span class="hljs-comment"># 42</span>
</code></pre>
<p>We defined our own meaning for <code>.on_failure</code> with <code>T::Configuration</code>. Without doing this, <code>.on_failure</code> has no effect. Because of this, <code>.on_failure</code> can be completely customized within any codebase to change what it means to fail. For example at Stripe, we use <code>.on_failure</code> to attach team ownership information to a failure.</p>
<p>The <code>T::Configuration</code> handler we wrote branches on whether <code>.on_failure</code> was provided, which means the logging behavior is opt in. This is nice because it means the default behavior is still to make problems with types fail loudly and early, rather than silently as a log. If we wanted, we could have inverted this:</p>
<pre><code class="hljs css language-ruby">T::Configuration.call_validation_error_handler = lambda <span class="hljs-keyword">do</span> <span class="hljs-params">|signature, opts|</span>
  <span class="hljs-comment">#                                                       ┌────┐</span>
  <span class="hljs-keyword">if</span> signature&amp;.on_failure &amp;&amp; signature&amp;.on_failure[<span class="hljs-number">0</span>] == <span class="hljs-symbol">:raise</span>
    raise TypeError.new(opts[<span class="hljs-symbol">:pretty_message</span>])
  <span class="hljs-keyword">else</span>
    puts opts[<span class="hljs-symbol">:pretty_message</span>]
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-comment"># ...</span>

<span class="hljs-comment">#                                       ┌─────────────────┐</span>
sig { params(<span class="hljs-symbol">argv:</span> T::Array[String]).void.on_failure(<span class="hljs-symbol">:raise</span>) }
</code></pre>
<p>With this <code>T::Configuration</code> handler, the default is to log, and we can use <code>.on_failure</code> to opt specific sigs into raising on failure.</p>
<p>We haven’t depicted it here, but the <code>T::Configuration</code> handler will get an array of every argument that was provided to <code>.on_failure</code> for this sig—specifically there’s no restriction that <code>.on_failure</code> must be given only one arg nor that the arg is a Symbol. For more on the various <code>T::Configuration</code> handlers, see <a href="/docs/tconfiguration">Runtime Configuration</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="checked-whether-to-check-in-the-first-place"></a><a href="#checked-whether-to-check-in-the-first-place" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>.checked</code>: Whether to check in the first place</h2>
<blockquote>
<p><strong>Careful!</strong> Opting out of runtime checks can significantly degrade the trustworthiness of type signatures. Only disable the runtime after understanding the tradeoffs. See <a href="/docs/gradual">Gradual Type Checking</a> to learn more.</p>
</blockquote>
<p>In our examples above with <code>.on_failure</code>, every method call had the runtime type checks run to determine whether the <code>T::Configuration</code> handler should be called in the first place. This comes with an overhead, and we carefully audit and monitor the performance of <code>sorbet-runtime</code> as a result. The overhead of these checks are usually very small.</p>
<p>But in some cases, especially when calling certain methods in tight loops or other latency-sensitive paths, the overhead of even doing the checks (regardless of what happens on failure) is prohibitively expensive. To handle these cases, Sorbet offers <code>.checked(...)</code> which declares in what environments a sig should be checked:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-comment"># (1) Runtime checks always run.</span>
sig { params(<span class="hljs-symbol">xs:</span> T::Array[String]).void.checked(<span class="hljs-symbol">:always</span>) }

<span class="hljs-comment"># (2) Runtime checks only run in "tests" (see below).</span>
<span class="hljs-comment"># In non-tests, this sig specifically has no runtime overhead.</span>
sig { params(<span class="hljs-symbol">xs:</span> T::Array[String]).void.checked(<span class="hljs-symbol">:tests</span>) }

<span class="hljs-comment"># (3) Never runs the runtime checks. Careful!</span>
sig { params(<span class="hljs-symbol">xs:</span> T::Array[String]).void.checked(<span class="hljs-symbol">:never</span>) }
</code></pre>
<p>If <code>.checked(...)</code> is omitted on a sig, the default is <code>.checked(:always)</code>. The default checked level can also be configured. For example:</p>
<pre><code class="hljs css language-ruby">T::Configuration.default_checked_level = <span class="hljs-symbol">:tests</span>
</code></pre>
<p>This can also be set via the <code>SORBET_RUNTIME_DEFAULT_CHECKED_LEVEL</code> environment variable, see <a href="/docs/tconfiguration#environment-variables">Environment Variables</a> for more.</p>
<p>Writing this will make it so that any sig which does not have a <code>.checked(...)</code> call in it will behave as if the user had written <code>.checked(:tests)</code>. To prevent accidental misuse, <code>sorbet-runtime</code> will require that this setting is changed before any <code>sig</code> is evaluated at runtime.</p>
<p><strong>Note</strong>: For <code>.checked(:tests)</code> to work correctly, checking in tests must be enabled in every entry point into the tests. To declare that a certain entry point is a test, run:</p>
<pre><code class="hljs css language-ruby">T::Configuration.enable_checking_for_sigs_marked_checked_tests
</code></pre>
<p>This can also be set via the <code>SORBET_RUNTIME_ENABLE_CHECKING_IN_TESTS</code> environment variable, see <a href="/docs/tconfiguration#environment-variables">Environment Variables</a> for more.</p>
<p>For example, this should probably be placed as the first line of any <code>rake test</code> target, as well as any other entry point to a project’s tests. If this line is absent, <code>.checked(:tests)</code> sigs behave as if they had been <code>.checked(:never)</code>.</p>
<h2><a class="anchor" aria-hidden="true" id="tsigwithoutruntimesig"></a><a href="#tsigwithoutruntimesig" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>T::Sig::WithoutRuntime.sig</code></h2>
<p>Even with <code>.checked(:never)</code>, there is some slight runtime overhead. The block for a <code>sig { ... }</code> above a method is not evaluated until the first time that method is called. But Sorbet can only know whether a sig is <code>.checked(:never)</code> or not until the block is evaluated. So even if a sig is marked <code>.checked(:never)</code>, Sorbet will still wrap the method. The first time the method is called, Sorbet will discover the <code>.checked(:never)</code> and put back the original method.</p>
<p>Sometimes even this tiny amount of runtime metaprogramming is unacceptable at runtime. To completely eliminate all runtime side effects when defining a signature, replace <code>sig</code> with <code>T::Sig::WithoutRuntime.sig</code> when annotating methods:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-comment"># typed: true</span>
<span class="hljs-keyword">require</span> <span class="hljs-string">"sorbet-runtime"</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Foo</span></span>
  extend T::Sig
  <span class="hljs-comment"># This signature will raise both statically and at runtime</span>
  <span class="hljs-comment"># (because `NotFound` doesn't exist, and causes a NameError)</span>
  sig { params(<span class="hljs-symbol">x:</span> NotFound).void.checked(<span class="hljs-symbol">:never</span>) }
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span><span class="hljs-params">(x)</span></span>; <span class="hljs-keyword">end</span>

  <span class="hljs-comment"># This signature will only raise statically</span>
  <span class="hljs-comment"># (the sig block is ignored completely at runtime)</span>
  T::Sig::WithoutRuntime.sig { params(<span class="hljs-symbol">x:</span> NotFound).void }
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bar</span><span class="hljs-params">(x)</span></span>; <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p><strong>Note</strong>: For consistency in large codebases, it’s best to avoid <code>T::Sig::WithoutRuntime</code> unless it can’t be avoided, because the performance win versus simply using <code>.checked(:never)</code> is marginal. Some examples:</p>
<ul>
<li>Circumstances make it impossible to put <code>extend T::Sig</code> in the class, but <code>sorbet-runtime</code> is still loaded.</li>
<li>The method is <code>method_missing</code> or <code>respond_to_missing?</code>, as <code>sorbet-runtime</code> does not support wrapping these methods.</li>
<li>Some code not under your control is trying to reflect on the result of <code>.parameters</code> or <code>.arity</code> of the sig’ed method. (Note that this precludes code under <em>your</em> control: Sorbet provides <a href="https://github.com/sorbet/sorbet/blob/0dbaf2c465314556b5acecec6ec63937f2b9e836/gems/sorbet-runtime/lib/types/utils.rb#L63-L68"><code>T::Utils.signature_for_method</code></a>, which exposes the arity of the underlying method.)</li>
<li>After careful measurements, even the first call to a method is performance sensitive. This is rare, but can happen when trying to optimize speed of code loading specifically.</li>
</ul>
<p>If none of these reasons apply, it’s best to avoid <code>T::Sig::WithoutRuntime</code>, because it will stand out versus most other usages of <code>sig</code> in a codebase.</p>
<h2><a class="anchor" aria-hidden="true" id="tlet-tcast-tmust-tbind"></a><a href="#tlet-tcast-tmust-tbind" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>T.let, T.cast, T.must, T.bind</h2>
<p>Type assertions like <code>T.let</code>, <code>T.cast</code>, <code>T.must</code>, and <code>T.bind</code> are normally checked at runtime, just like <code>sig</code> annotations on methods, unless runtime checks have been disabled.</p>
<p>Unlike method signatures, type assertions <em>always</em> have a performance cost, whether or not they are checked at runtime. See <a href="/docs/type-assertions">Type Assertions</a> for tips on patterns that reduce or avoid this cost.</p>
<h2><a class="anchor" aria-hidden="true" id="whats-next"></a><a href="#whats-next" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What’s next?</h2>
<ul>
<li><p><a href="/docs/sigs">Signatures</a></p>
<p>Method signatures are the primary way that we add static and dynamic type checking in our code. Learn the available syntax advanced features of signatures.</p></li>
<li><p><a href="/docs/tconfiguration">Runtime Configuration</a></p>
<p>Learn how to change or disable Sorbet’s runtime type checks via settings and callbacks.</p></li>
</ul>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1"  class="footnote-item"><p>The case for <code>.void</code> in a <code>sig</code> is slightly different. See <a href="/docs/sigs#returns-void-annotating-return-types">the docs
for void</a>. <a href="#fnref1" class="footnote-backref">↩</a></p>
</li>
</ol>
</section>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/static"><span class="arrow-prev">← </span><span>Enabling Static Checks</span></a><a class="docs-next button" href="/docs/rbi"><span>RBI Files</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#runtime-checked-sigs">Runtime-checked <code>sig</code>s</a></li><li><a href="#why-have-runtime-checks">Why have runtime checks?</a></li><li><a href="#changing-the-runtime-behavior">Changing the runtime behavior</a></li><li><a href="#on_failure-changing-what-happens-on-runtime-errors"><code>.on_failure</code>: Changing what happens on runtime errors</a></li><li><a href="#checked-whether-to-check-in-the-first-place"><code>.checked</code>: Whether to check in the first place</a></li><li><a href="#tsigwithoutruntimesig"><code>T::Sig::WithoutRuntime.sig</code></a></li><li><a href="#tlet-tcast-tmust-tbind">T.let, T.cast, T.must, T.bind</a></li><li><a href="#whats-next">What's next?</a></li></ul></nav></div><footer class="nav-footer" id="footer"><div class="wrapper"><p class="footer"><svg width="99" height="28" viewBox="0 0 99 28" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.98432 20H6.27432C8.44932 20 9.81432 18.905 9.81432 17.03C9.81432 15.665 9.00432 14.72 7.78932 14.39C8.61432 14.105 9.45432 13.415 9.45432 12.035C9.45432 10.235 8.23932 9.23 5.95932 9.23H1.98432V20ZM3.37932 13.85V10.445H5.83932C7.27932 10.445 8.07432 11 8.07432 12.155C8.07432 13.295 7.27932 13.85 5.83932 13.85H3.37932ZM3.37932 15.08H6.21432C7.65432 15.08 8.43432 15.83 8.43432 16.925C8.43432 18.035 7.65432 18.785 6.21432 18.785H3.37932V15.08ZM18.0294 12.155H16.6794V16.88C16.6794 18.185 15.6894 18.92 14.7144 18.92C13.5594 18.92 13.0794 18.17 13.0794 17.06V12.155H11.7294V17.345C11.7294 19.01 12.6744 20.165 14.3544 20.165C15.4644 20.165 16.2294 19.58 16.6794 18.92V20H18.0294V12.155ZM20.5112 10.79H21.9812V9.23H20.5112V10.79ZM21.9212 12.155H20.5712V20H21.9212V12.155ZM25.8247 9.23H24.4747V20H25.8247V9.23ZM28.5882 18.125C28.5882 19.625 29.3532 20.075 30.6882 20.075C31.1382 20.075 31.5282 20.03 31.8732 19.955V18.8C31.5582 18.875 31.3332 18.89 31.0182 18.89C30.3282 18.89 29.9232 18.74 29.9232 17.915V13.31H31.7082V12.155H29.9232V9.86H28.5882V12.155H27.3732V13.31H28.5882V18.125ZM41.0199 20.165C43.1949 20.165 44.4399 18.305 44.4399 16.085C44.4399 13.85 43.1949 12.005 41.0199 12.005C39.9249 12.005 39.0549 12.53 38.5899 13.295V9.23H37.2399V20H38.5899V18.86C39.0549 19.64 39.9249 20.165 41.0199 20.165ZM38.5599 15.815C38.5599 13.985 39.6699 13.19 40.7799 13.19C42.2499 13.19 43.0749 14.39 43.0749 16.085C43.0749 17.765 42.2499 18.98 40.7799 18.98C39.6699 18.98 38.5599 18.17 38.5599 16.37V15.815ZM49.1804 20.855L52.5554 12.155H51.1454L48.9704 18.155L46.7654 12.155H45.3404L48.2504 19.715L47.8754 20.645C47.5604 21.425 47.2454 21.635 46.6604 21.635C46.4354 21.635 46.2704 21.62 46.0154 21.56V22.73C46.2554 22.775 46.4204 22.79 46.7504 22.79C48.1154 22.79 48.7304 22.04 49.1804 20.855Z" fill="white"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M98.7993 15.7838C98.7993 12.8786 97.3871 10.5862 94.688 10.5862C91.9774 10.5862 90.3374 12.8786 90.3374 15.7611C90.3374 19.177 92.2735 20.9019 95.0524 20.9019C96.4077 20.9019 97.4327 20.5955 98.2071 20.1643V17.8946C97.4327 18.2804 96.5443 18.5188 95.4168 18.5188C94.3121 18.5188 93.3327 18.1329 93.2074 16.7938H98.7766C98.7766 16.6463 98.7993 16.0561 98.7993 15.7838ZM93.1732 14.7057C93.1732 13.4233 93.9591 12.8899 94.6766 12.8899C95.3713 12.8899 96.1116 13.4233 96.1116 14.7057H93.1732Z" fill="white"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M85.9413 10.5862C84.8251 10.5862 84.1076 11.1082 83.709 11.4714L83.561 10.7678H81.0554V24.0001L83.9026 23.3986L83.914 20.187C84.324 20.482 84.9276 20.9019 85.9299 20.9019C87.9685 20.9019 89.8249 19.2678 89.8249 15.6703C89.8135 12.3792 87.9343 10.5862 85.9413 10.5862ZM85.2579 18.4053C84.586 18.4053 84.1874 18.167 83.914 17.8719L83.9026 13.6616C84.1988 13.3325 84.6088 13.1055 85.2579 13.1055C86.2943 13.1055 87.0118 14.2631 87.0118 15.7497C87.0118 17.2704 86.3057 18.4053 85.2579 18.4053Z" fill="white"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M77.1377 9.91656L79.9963 9.30374V7L77.1377 7.60147V9.91656Z" fill="white"></path><path d="M79.9963 10.7791H77.1377V20.709H79.9963V10.7791Z" fill="white"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M74.074 11.6187L73.8918 10.7789H71.4318V20.7088H74.279V13.9792C74.9509 13.1054 76.0898 13.2642 76.4429 13.3891V10.7789C76.0784 10.6427 74.7459 10.3931 74.074 11.6187Z" fill="white"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M68.3796 8.31641L65.6007 8.90653L65.5894 17.9966C65.5894 19.6762 66.8535 20.9132 68.5391 20.9132C69.473 20.9132 70.1563 20.743 70.5321 20.5387V18.235C70.1677 18.3825 68.3682 18.9045 68.3682 17.225V13.1962H70.5321V10.779H68.3682L68.3796 8.31641Z" fill="white"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M60.6807 13.6616C60.6807 13.219 61.0452 13.0488 61.6488 13.0488C62.5143 13.0488 63.6076 13.3098 64.4732 13.7751V11.1082C63.5279 10.7337 62.594 10.5862 61.6488 10.5862C59.3368 10.5862 57.7993 11.7891 57.7993 13.7978C57.7993 16.93 62.1271 16.4306 62.1271 17.7811C62.1271 18.3031 61.6715 18.4734 61.0338 18.4734C60.0885 18.4734 58.8813 18.0875 57.9246 17.5655V20.2664C58.9838 20.7204 60.0543 20.9133 61.0338 20.9133C63.4026 20.9133 65.0313 19.7444 65.0313 17.713C65.0199 14.3312 60.6807 14.9326 60.6807 13.6616Z" fill="white"></path></svg><a href="/docs/adopting">Get started</a> · <a href="/docs/overview">Docs</a> · <a href="https://sorbet.run">Try</a> · <a href="/en/community">Community</a> · <a href="/blog">Blog</a> · <a href="https://twitter.com/sorbet_ruby">Twitter</a></p></div><div id="csat-extension-config" data-notify="#sorbet-team"></div></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                appId: 'ZYWC6Z01G8',
                apiKey: 'b05a65e9f8d9f50dc4ec3241db8836c4',
                indexName: 'stripe_sorbet',
                inputSelector: '#search_input_react',
                algoliaOptions: {}
              });
            </script></body></html>