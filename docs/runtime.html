<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Enabling Runtime Checks ¬∑ Sorbet</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="As we&#x27;ve mentioned before, Sorbet is a [gradual](/docs/gradual) system: it can be"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Enabling Runtime Checks ¬∑ Sorbet"/><meta property="og:type" content="website"/><meta property="og:url" content="https://sorbet.org/"/><meta property="og:description" content="As we&#x27;ve mentioned before, Sorbet is a [gradual](/docs/gradual) system: it can be"/><meta property="og:image" content="https://sorbet.org/img/sorbet-logo-card@2x.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://sorbet.org/img/sorbet-logo-card@2x.png"/><link rel="shortcut icon" href="/img/favicon.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://sorbet.org/blog/atom.xml" title="Sorbet Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://sorbet.org/blog/feed.xml" title="Sorbet Blog RSS Feed"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-119877071-2', 'auto');
              ga('send', 'pageview');
            </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/sorbet-logo-white-sparkles.svg" alt="Sorbet"/><h2 class="headerTitleWithLogo">Sorbet</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/adopting" target="_self">Get started</a></li><li class="siteNavGroupActive"><a href="/docs/overview" target="_self">Docs</a></li><li class=""><a href="https://sorbet.run" target="_self">Try</a></li><li class=""><a href="/en/community" target="_self">Community</a></li><li class=""><a href="https://github.com/sorbet/sorbet" target="_self">GitHub</a></li><li class=""><a href="/blog/" target="_self">Blog</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>‚Ä∫</i><span>Static &amp; Runtime</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Getting Started</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/overview">Overview</a></li><li class="navListItem"><a class="navItem" href="/docs/adopting">Adopting Sorbet</a></li><li class="navListItem"><a class="navItem" href="/docs/metrics">Tracking Adoption</a></li><li class="navListItem"><a class="navItem" href="/docs/quickref">Quick Reference</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Static &amp; Runtime</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/gradual">Gradual Type Checking</a></li><li class="navListItem"><a class="navItem" href="/docs/static">Enabling Static Checks</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/runtime">Enabling Runtime Checks</a></li><li class="navListItem"><a class="navItem" href="/docs/rbi">RBI Files</a></li><li class="navListItem"><a class="navItem" href="/docs/cli">Command Line Reference</a></li><li class="navListItem"><a class="navItem" href="/docs/tconfiguration">Runtime Configuration</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Troubleshooting</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/troubleshooting">Troubleshooting</a></li><li class="navListItem"><a class="navItem" href="/docs/faq">FAQ</a></li><li class="navListItem"><a class="navItem" href="/docs/error-reference">Error Reference</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Type System</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/sigs">Signatures</a></li><li class="navListItem"><a class="navItem" href="/docs/type-annotations">Type Annotations</a></li><li class="navListItem"><a class="navItem" href="/docs/type-assertions">Type Assertions</a></li><li class="navListItem"><a class="navItem" href="/docs/class-types">Class Types</a></li><li class="navListItem"><a class="navItem" href="/docs/nilable-types">Nilable Types</a></li><li class="navListItem"><a class="navItem" href="/docs/union-types">Union Types</a></li><li class="navListItem"><a class="navItem" href="/docs/flow-sensitive">Flow Sensitivity</a></li><li class="navListItem"><a class="navItem" href="/docs/type-aliases">Type Aliases</a></li><li class="navListItem"><a class="navItem" href="/docs/exhaustiveness">Exhaustiveness Checking</a></li><li class="navListItem"><a class="navItem" href="/docs/tstruct">T::Struct</a></li><li class="navListItem"><a class="navItem" href="/docs/tenum">T::Enum</a></li><li class="navListItem"><a class="navItem" href="/docs/untyped">T.untyped</a></li><li class="navListItem"><a class="navItem" href="/docs/procs">Blocks, Procs, &amp; Lambdas</a></li><li class="navListItem"><a class="navItem" href="/docs/abstract">Abstract Classes &amp; Interfaces</a></li><li class="navListItem"><a class="navItem" href="/docs/final">Final Methods &amp; Classes</a></li><li class="navListItem"><a class="navItem" href="/docs/override-checking">Override Checking</a></li><li class="navListItem"><a class="navItem" href="/docs/sealed">Sealed Classes</a></li><li class="navListItem"><a class="navItem" href="/docs/class-of">T.class_of</a></li><li class="navListItem"><a class="navItem" href="/docs/stdlib-generics">Arrays &amp; Hashes</a></li><li class="navListItem"><a class="navItem" href="/docs/self-type">T.self_type</a></li><li class="navListItem"><a class="navItem" href="/docs/noreturn">T.noreturn</a></li><li class="navListItem"><a class="navItem" href="/docs/attached-class">T.attached_class</a></li><li class="navListItem"><a class="navItem" href="/docs/intersection-types">Intersection Types</a></li><li class="navListItem"><a class="navItem" href="/docs/non-forcing-constants">T::NonForcingConstants</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Experimental Features</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/tuples">Tuples</a></li><li class="navListItem"><a class="navItem" href="/docs/shapes">Shapes</a></li><li class="navListItem"><a class="navItem" href="/docs/requires-ancestor">Requiring Ancestors</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://github.com/sorbet/sorbet/edit/master/website/docs/runtime.md" target="_blank" rel="noreferrer noopener">Edit</a><h1 id="__docusaurus" class="postHeaderTitle">Enabling Runtime Checks</h1></header><article><div><span><p>As we‚Äôve mentioned before, Sorbet is a <a href="/docs/gradual">gradual</a> system: it can be
turned on and off at will. This means the predictions <code>srb</code> makes statically can
be wrong.</p>
<p>That‚Äôs why Sorbet also uses <strong>runtime checks</strong>: even if a static prediction was
wrong, it will get checked during runtime, making things fail loudly and
immediately, rather than silently and after the fact.</p>
<p>In this doc we‚Äôll answer:</p>
<ul>
<li>What‚Äôs the runtime effect of adding a <code>sig</code> to a method?</li>
<li>Why do we want to have a runtime effect?</li>
<li>What are our options if we don‚Äôt want <code>sig</code>s to affect the runtime?</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="runtime-checked-sigs"></a><a href="#runtime-checked-sigs" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Runtime-checked <code>sig</code>s</h2>
<p>Adding a method signature opts that method into runtime typechecks (in addition
to opting it into <a href="/docs/static">more static checks</a>). In this sense,
<code>sorbet-runtime</code> is similar to libraries for adding runtime contracts.</p>
<p>Concretely, adding a <code>sig</code> wraps the method defined beneath it in a new method
that:</p>
<ul>
<li>validates the types of arguments passed in against the types in the <code>sig</code></li>
<li>calls the original method</li>
<li>validates the return type of the original method against what was declared</li>
<li>returns what the original method returned<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></li>
</ul>
<!-- prettier-ignore-start -->
<!-- prettier-ignore-end -->
<p>For example:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-keyword">require</span> <span class="hljs-string">'sorbet-runtime'</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Example</span></span>
  extend T::Sig

  sig {params(<span class="hljs-symbol">x:</span> Integer).returns(String)}
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">main</span><span class="hljs-params">(x)</span></span>
    <span class="hljs-string">"Passed: <span class="hljs-subst">#{x.to_s}</span>"</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

Example.main([]) <span class="hljs-comment"># passing an Array!</span>
</code></pre>
<pre><code class="hljs css language-shell">‚ùØ ruby example.rb
...
Parameter 'x': Expected type Integer, got type Array with unprintable value (TypeError)
Caller: example.rb:11
Definition: example.rb:6
...
</code></pre>
<p>In this small example, we have a <code>main</code> method defined to take an Integer, but
we‚Äôre passing an Array at the call site. When we run <code>ruby</code> on our example file,
sorbet-runtime raises an exception because the signature was violated.</p>
<h2><a class="anchor" aria-hidden="true" id="why-have-runtime-checks"></a><a href="#why-have-runtime-checks" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Why have runtime checks?</h2>
<p>Runtime checks have been invaluable when developing Sorbet and rolling it out in
large Ruby codebases like Stripe‚Äôs. Type annotations in a codebase are near
useless if developers don‚Äôt trust them (consider how often YARD annotations fall
out of sync with the code‚Ä¶ üò∞).</p>
<p>Adding a <code>sig</code> to a method is only as good as the predictions it lets <code>srb</code> make
about a codebase. Wrong sigs are actively harmful. Specifically, when <code>sig</code>s in
our codebase are wrong:</p>
<ul>
<li>we can‚Äôt use them to find code to refactor. Sorbet will think some code paths
can never be reached when they actually can.</li>
<li>they‚Äôre effectively as good as out-of-date documentation, with little added
benefit over just comments.</li>
<li>we could never use them to make Ruby code run faster. In the future, we hope
to use Sorbet types to make Ruby faster, but <code>sig</code>s that lie will actually
make code <em>slower</em> than no types at all.</li>
</ul>
<p>By leveraging runtime checks, we can gain lots of confidence and trust in our
type annotations:</p>
<ul>
<li>Automated test runs become tests of our type annotations!</li>
<li>Our production observability and monitoring catch bad sigs <strong>early</strong>, before
they propagate false assumptions throughout a codebase.</li>
</ul>
<p>To drive these points home, let‚Äôs look at a concrete example:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-comment"># typed: true</span>
<span class="hljs-keyword">require</span> <span class="hljs-string">'sorbet-runtime'</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Example</span></span>
  extend T::Sig

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">some_untyped_method</span></span>
    <span class="hljs-literal">nil</span>
  <span class="hljs-keyword">end</span>

  sig {params(<span class="hljs-symbol">x:</span> Integer).returns(Integer)}
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">add_one</span><span class="hljs-params">(x)</span></span>
    x + <span class="hljs-number">1</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

Example.add_one(Example.some_untyped_method)
</code></pre>
<p><a href="https://sorbet.run/#%23%20typed%3A%20true%0Arequire%20'sorbet-runtime'%0A%0Aclass%20Example%0A%20%20extend%20T%3A%3ASig%0A%0A%20%20def%20self.some_untyped_method%0A%20%20%20%20nil%0A%20%20end%0A%0A%20%20sig%20%7Bparams(x%3A%20Integer).returns(Integer)%7D%0A%20%20def%20self.add_one(x)%0A%20%20%20%20x%20%2B%201%0A%20%20end%0Aend%0A%0AExample.add_one(Example.some_untyped_method)">‚Üí
View on sorbet.run</a></p>
<p>In this example, <code>srb tc</code> reports that there were <strong>no errors statically</strong>. But
if we were to run this code with <code>ruby</code>, <code>some_untyped_method</code> would return
<code>nil</code>, we‚Äôd try to add <code>1</code> to it, and Ruby would raise a NoMethodError for <code>+</code>.
By adding a <code>sig</code> to <code>add_one</code>, the Sorbet runtime will raise an exception
before even starting to execute the method. This makes typing errors from
untyped code manifest early and loudly and right at the source, rather than
silently, long after a sig was added, and far removed from this line of code.</p>
<p>Most people are <em>either</em> familiar with a completely typed language (Java, Go,
etc.) or a completely untyped language like Ruby; a
<a href="/docs/gradual">gradual type system</a> can be very foreign at first. Including these
runtime checks by default protects typed code from untyped code, making it
easier to drive adoption of types in the long run.</p>
<h2><a class="anchor" aria-hidden="true" id="changing-the-runtime-behavior"></a><a href="#changing-the-runtime-behavior" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Changing the runtime behavior</h2>
<p>While having runtime checks is the default, it‚Äôs possible to change the behavior
of the runtime system via configuration settings. These configuration settings
live in under the <code>T::Configuration</code> module within the <code>sorbet-runtime</code> gem.</p>
<p>There are two main ways to change Sorbet‚Äôs runtime:</p>
<ul>
<li><p><strong>When</strong> the runtime checks fail, what to do in response.</p>
<p>To change this, we use <code>.on_failure</code> in a method signature.</p></li>
<li><p><strong>Whether</strong> the runtime checks run in the first place.</p>
<p>To change this, we use <code>.checked</code> in a method signature.</p></li>
</ul>
<p>In the next sections, we‚Äôll give some examples of how to use both.</p>
<h2><a class="anchor" aria-hidden="true" id="on_failure-changing-what-happens-on-runtime-errors"></a><a href="#on_failure-changing-what-happens-on-runtime-errors" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>.on_failure</code>: Changing what happens on runtime errors</h2>
<p>By adding <code>.on_failure(...)</code> to a sig and registering a <code>T::Configuration</code>
callback, we can change what happens when a sig check fails. For example:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-keyword">require</span> <span class="hljs-string">'sorbet-runtime'</span>

<span class="hljs-comment"># (1) Register call_validation_error_handler callback.</span>
<span class="hljs-comment"># This runs every time a method with a sig fails to type check at runtime.</span>
T::Configuration.call_validation_error_handler = lambda <span class="hljs-keyword">do</span> <span class="hljs-params">|signature, opts|</span>
  <span class="hljs-comment">#                                                     ‚îå‚îÄ‚îÄ‚îê</span>
  <span class="hljs-keyword">if</span> signature.on_failure &amp;&amp; signature.on_failure[<span class="hljs-number">0</span>] == <span class="hljs-symbol">:log</span>
    puts opts[<span class="hljs-symbol">:pretty_message</span>]
  <span class="hljs-keyword">else</span>
    raise TypeError.new(opts[<span class="hljs-symbol">:pretty_message</span>])
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span></span>
  extend T::Sig

  <span class="hljs-comment"># (2) Use .on_failure in the sig for a method</span>
  <span class="hljs-comment">#                                       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê</span>
  sig {params(<span class="hljs-symbol">argv:</span> T::Array[String]).void.on_failure(<span class="hljs-symbol">:log</span>)}
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">main</span><span class="hljs-params">(argv)</span></span>
    puts argv
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-comment"># (3) When we call main incorrectly, it will print</span>
<span class="hljs-comment"># with puts instead of raise an exception.</span>
Main.main(<span class="hljs-number">42</span>)

<span class="hljs-comment"># Output:</span>
<span class="hljs-comment"># ‚ùØ ruby example.rb</span>
<span class="hljs-comment"># Parameter 'argv': Expected type T::Array[String], got type Integer with value 42</span>
<span class="hljs-comment"># Caller: example.rb:25</span>
<span class="hljs-comment"># Definition: example.rb:18</span>
<span class="hljs-comment"># 42</span>
</code></pre>
<p>We defined our own meaning for <code>.on_failure</code> with <code>T::Configuration</code>. Without
doing this, <code>.on_failure</code> has no effect. Because of this, <code>.on_failure</code> can be
completely customized within any codebase to change what it means to fail. For
example at Stripe, we use <code>.on_failure</code> to attach team ownership information to
a failure.</p>
<p>The <code>T::Configuration</code> handler we wrote branches on whether <code>.on_failure</code> was
provided, which means the logging behavior is opt in. This is nice because it
means the default behavior is still to make problems with types fail loudly and
early, rather than silently as a log. If we wanted, we could have inverted this:</p>
<pre><code class="hljs css language-ruby">T::Configuration.call_validation_error_handler = lambda <span class="hljs-keyword">do</span> <span class="hljs-params">|signature, opts|</span>
  <span class="hljs-comment">#                                                     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îê</span>
  <span class="hljs-keyword">if</span> signature.on_failure &amp;&amp; signature.on_failure[<span class="hljs-number">0</span>] == <span class="hljs-symbol">:raise</span>
    raise TypeError.new(opts[<span class="hljs-symbol">:pretty_message</span>])
  <span class="hljs-keyword">else</span>
    puts opts[<span class="hljs-symbol">:pretty_message</span>]
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-comment"># ...</span>

<span class="hljs-comment">#                                       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê</span>
sig {params(<span class="hljs-symbol">argv:</span> T::Array[String]).void.on_failure(<span class="hljs-symbol">:raise</span>)}
</code></pre>
<p>With this <code>T::Configuration</code> handler, the default is to log, and we can use
<code>.on_failure</code> to opt specific sigs into raising on failure.</p>
<p>We haven‚Äôt depicted it here, but the <code>T::Configuration</code> handler will get an
array of every argument that was provided to <code>.on_failure</code> for this
sig‚Äîspecifically there‚Äôs no restriction that <code>.on_failure</code> must be given only
one arg nor that the arg is a Symbol. For more on the various <code>T::Configuration</code>
handlers, see <a href="/docs/tconfiguration">Runtime Configuration</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="checked-whether-to-check-in-the-first-place"></a><a href="#checked-whether-to-check-in-the-first-place" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>.checked</code>: Whether to check in the first place</h2>
<blockquote>
<p><strong>Careful!</strong> Opting out of runtime checks can significantly degrade the
trustworthiness of type signatures. Only disable the runtime after
understanding the tradeoffs. See <a href="/docs/gradual">Gradual Type Checking</a> to learn
more.</p>
</blockquote>
<p>In our examples above with <code>.on_failure</code>, every method call had the runtime type
checks run to determine whether the <code>T::Configuration</code> handler should be called
in the first place. This comes with an overhead, and we carefully audit and
monitor the performance of <code>sorbet-runtime</code> as a result. The overhead of these
checks are usually very small.</p>
<p>But in some cases, especially when calling certain methods in tight loops or
other latency-sensitive paths, the overhead of even doing the checks (regardless
of what happens on failure) is prohibitively expensive. To handle these cases,
Sorbet offers <code>.checked(...)</code> which declares in what environments a sig should
be checked:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-comment"># (1) Runtime checks always run.</span>
sig {params(<span class="hljs-symbol">xs:</span> T::Array[String]).void.checked(<span class="hljs-symbol">:always</span>)}

<span class="hljs-comment"># (2) Runtime checks only run in "tests" (see below).</span>
<span class="hljs-comment"># In non-tests, this sig specifically has no runtime overhead.</span>
sig {params(<span class="hljs-symbol">xs:</span> T::Array[String]).void.checked(<span class="hljs-symbol">:tests</span>)}

<span class="hljs-comment"># (3) Never runs the runtime checks. Careful!</span>
sig {params(<span class="hljs-symbol">xs:</span> T::Array[String]).void.checked(<span class="hljs-symbol">:never</span>)}

<span class="hljs-comment"># (4) Runtime checks only run when the file is using the Sorbet Compiler.</span>
<span class="hljs-comment"># In the interpreter, this behaves identically to checked(:never).</span>
sig {params(<span class="hljs-symbol">xs:</span> T::Array[String]).void.checked(<span class="hljs-symbol">:compiled</span>)}
</code></pre>
<p>If <code>.checked(...)</code> is omitted on a sig, the default is <code>.checked(:always)</code>. The
default checked level can also be configured. For example:</p>
<pre><code class="hljs css language-ruby">T::Configuration.default_checked_level = <span class="hljs-symbol">:tests</span>
</code></pre>
<p>Writing this will make it so that any sig which does not have a <code>.checked(...)</code>
call in it will behave as if the user had written <code>.checked(:tests)</code>. To prevent
accidental misuse, <code>sorbet-runtime</code> will require that this setting is changed
before any <code>sig</code> is evaluated at runtime.</p>
<p><strong>Note</strong>: For <code>.checked(:tests)</code> to work correctly, checking in tests must be
enabled in every entry point into the tests. To declare that a certain entry
point is a test, run:</p>
<pre><code class="hljs css language-ruby">T::Configuration.enable_checking_for_sigs_marked_checked_tests
</code></pre>
<p>For example, this should probably be placed as the first line of any <code>rake test</code>
target, as well as any other entry point to a project‚Äôs tests. If this line is
absent, <code>.checked(:tests)</code> sigs behave as if they had been <code>.checked(:never)</code>.</p>
<h2><a class="anchor" aria-hidden="true" id="tsigwithoutruntimesig"></a><a href="#tsigwithoutruntimesig" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>T::Sig::WithoutRuntime.sig</code></h2>
<p>Even with <code>.checked(:never)</code>, there is some slight runtime overhead. The block
for a <code>sig {...}</code> above a method is not evaluated until the first time that
method is called. But Sorbet can only know whether a sig is <code>.checked(:never)</code>
or not until the block is evaluated. So even if a sig is marked
<code>.checked(:never)</code>, Sorbet will still wrap the method. The first time the method
is called, Sorbet will discover the <code>.checked(:never)</code> and put back the original
method.</p>
<p>Sometimes even this tiny amount of runtime metaprogramming is unnacceptable at
runtime. To completely eliminate all runtime side effects when defining a
signature, replace <code>sig</code> with <code>T::Sig::WithoutRuntime.sig</code> when annotating
methods:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-comment"># typed: true</span>
<span class="hljs-keyword">require</span> <span class="hljs-string">"sorbet-runtime"</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Foo</span></span>
  extend T::Sig
  <span class="hljs-comment"># This signature will raise both statically and at runtime</span>
  <span class="hljs-comment"># (because `NotFound` doesn't exist, and causes a NameError)</span>
  sig { params(<span class="hljs-symbol">x:</span> NotFound).void.checked(<span class="hljs-symbol">:never</span>) }
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span><span class="hljs-params">(x)</span></span>; <span class="hljs-keyword">end</span>

  <span class="hljs-comment"># This signature will only raise statically</span>
  <span class="hljs-comment"># (the sig block is ignored completely at runtime)</span>
  T::Sig::WithoutRuntime.sig { params(<span class="hljs-symbol">x:</span> NotFound).void }
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bar</span><span class="hljs-params">(x)</span></span>; <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="whats-next"></a><a href="#whats-next" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What‚Äôs next?</h2>
<ul>
<li><p><a href="/docs/sigs">Signatures</a></p>
<p>Method signatures are the primary way that we add static and dynamic type
checking in our code. Learn the available syntax advanced features of
signatures.</p></li>
<li><p><a href="/docs/tconfiguration">Runtime Configuration</a></p>
<p>Learn how to change or disable Sorbet‚Äôs runtime type checks via settings and
callbacks.</p></li>
</ul>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1"  class="footnote-item"><p>The case for <code>.void</code> in a <code>sig</code> is slightly different. See <a href="/docs/sigs#returns-void-annotating-return-types">the docs
for void</a>. <a href="#fnref1" class="footnote-backref">‚Ü©</a></p>
</li>
</ol>
</section>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/static"><span class="arrow-prev">‚Üê </span><span>Enabling Static Checks</span></a><a class="docs-next button" href="/docs/rbi"><span>RBI Files</span><span class="arrow-next"> ‚Üí</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#runtime-checked-sigs">Runtime-checked <code>sig</code>s</a></li><li><a href="#why-have-runtime-checks">Why have runtime checks?</a></li><li><a href="#changing-the-runtime-behavior">Changing the runtime behavior</a></li><li><a href="#on_failure-changing-what-happens-on-runtime-errors"><code>.on_failure</code>: Changing what happens on runtime errors</a></li><li><a href="#checked-whether-to-check-in-the-first-place"><code>.checked</code>: Whether to check in the first place</a></li><li><a href="#tsigwithoutruntimesig"><code>T::Sig::WithoutRuntime.sig</code></a></li><li><a href="#whats-next">What's next?</a></li></ul></nav></div><footer class="nav-footer" id="footer"><div class="wrapper"><p class="footer">¬© 2021 Stripe ¬∑ <a href="/docs/adopting">Get started</a> ¬∑ <a href="/docs/overview">Docs</a> ¬∑ <a href="https://sorbet.run">Try</a> ¬∑ <a href="/en/community">Community</a> ¬∑ <a href="/blog">Blog</a> ¬∑ <a href="https://twitter.com/sorbet_ruby">Twitter</a></p></div></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                appId: 'ZYWC6Z01G8',
                apiKey: 'b05a65e9f8d9f50dc4ec3241db8836c4',
                indexName: 'stripe_sorbet',
                inputSelector: '#search_input_react',
                algoliaOptions: {}
              });
            </script></body></html>