<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>T.attached_class · Sorbet</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="`T.attached_class` can be used to refer to the type of instances from a singleton-context, in a way that is friendly to inheritance."/><meta name="docsearch:language" content="en"/><meta property="og:title" content="T.attached_class · Sorbet"/><meta property="og:type" content="website"/><meta property="og:url" content="https://sorbet.org/"/><meta property="og:description" content="`T.attached_class` can be used to refer to the type of instances from a singleton-context, in a way that is friendly to inheritance."/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/favicon.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://sorbet.org/blog/atom.xml" title="Sorbet Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://sorbet.org/blog/feed.xml" title="Sorbet Blog RSS Feed"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-5H7PQ9Z8KF"></script><script>
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments); }
              gtag('js', new Date());
              gtag('config', 'G-5H7PQ9Z8KF');
            </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/sorbet-logo-white-sparkles.svg" alt="Sorbet"/><h2 class="headerTitleWithLogo">Sorbet</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/adopting" target="_self">Get started</a></li><li class="siteNavGroupActive"><a href="/docs/overview" target="_self">Docs</a></li><li class=""><a href="https://sorbet.run" target="_self">Try</a></li><li class=""><a href="/en/community" target="_self">Community</a></li><li class=""><a href="https://github.com/sorbet/sorbet" target="_self">GitHub</a></li><li class=""><a href="/blog/" target="_self">Blog</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Type System</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Getting Started</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/overview">Overview</a></li><li class="navListItem"><a class="navItem" href="/docs/adopting">Adopting Sorbet</a></li><li class="navListItem"><a class="navItem" href="/docs/metrics">Tracking Adoption</a></li><li class="navListItem"><a class="navItem" href="/docs/quickref">Quick Reference</a></li><li class="navListItem"><a class="navItem" href="/docs/vscode">Visual Studio Code</a></li><li class="navListItem"><a class="navItem" href="/docs/from-typescript">TypeScript ↔ Sorbet</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Static &amp; Runtime</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/gradual">Gradual Type Checking</a></li><li class="navListItem"><a class="navItem" href="/docs/static">Enabling Static Checks</a></li><li class="navListItem"><a class="navItem" href="/docs/runtime">Enabling Runtime Checks</a></li><li class="navListItem"><a class="navItem" href="/docs/rbi">RBI Files</a></li><li class="navListItem"><a class="navItem" href="/docs/cli">CLI Quickstart</a></li><li class="navListItem"><a class="navItem" href="/docs/cli-ref">CLI Reference</a></li><li class="navListItem"><a class="navItem" href="/docs/tconfiguration">Runtime Configuration</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Troubleshooting</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/troubleshooting">Troubleshooting</a></li><li class="navListItem"><a class="navItem" href="/docs/why-type-annotations">Why type annotations?</a></li><li class="navListItem"><a class="navItem" href="/docs/faq">FAQ</a></li><li class="navListItem"><a class="navItem" href="/docs/error-reference">Error Reference</a></li><li class="navListItem"><a class="navItem" href="/docs/unsupported">Unsupported Ruby Features</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Type System</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/sigs">sig</a></li><li class="navListItem"><a class="navItem" href="/docs/type-annotations">Type Annotations (non-sig)</a></li><li class="navListItem"><a class="navItem" href="/docs/type-assertions">T.let, T.cast, T.must, T.bind</a></li><li class="navListItem"><a class="navItem" href="/docs/class-types">Class Types (Integer, String)</a></li><li class="navListItem"><a class="navItem" href="/docs/stdlib-generics">Arrays &amp; Hashes</a></li><li class="navListItem"><a class="navItem" href="/docs/nilable-types">Nilable Types (T.nilable)</a></li><li class="navListItem"><a class="navItem" href="/docs/union-types">Union Types (T.any)</a></li><li class="navListItem"><a class="navItem" href="/docs/flow-sensitive">Flow-Sensitivity (is_a?, nil?)</a></li><li class="navListItem"><a class="navItem" href="/docs/type-aliases">T.type_alias</a></li><li class="navListItem"><a class="navItem" href="/docs/exhaustiveness">Exhaustiveness (T.absurd)</a></li><li class="navListItem"><a class="navItem" href="/docs/tstruct">T::Struct</a></li><li class="navListItem"><a class="navItem" href="/docs/tenum">T::Enum</a></li><li class="navListItem"><a class="navItem" href="/docs/untyped">T.untyped</a></li><li class="navListItem"><a class="navItem" href="/docs/procs">Blocks, Procs, &amp; Lambdas</a></li><li class="navListItem"><a class="navItem" href="/docs/abstract">Abstract Classes &amp; Interfaces</a></li><li class="navListItem"><a class="navItem" href="/docs/final">Final Methods &amp; Classes</a></li><li class="navListItem"><a class="navItem" href="/docs/override-checking">Override Checking</a></li><li class="navListItem"><a class="navItem" href="/docs/sealed">Sealed Classes</a></li><li class="navListItem"><a class="navItem" href="/docs/class-of">T.class_of</a></li><li class="navListItem"><a class="navItem" href="/docs/self-type">T.self_type</a></li><li class="navListItem"><a class="navItem" href="/docs/noreturn">T.noreturn</a></li><li class="navListItem"><a class="navItem" href="/docs/anything">T.anything</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/attached-class">T.attached_class</a></li><li class="navListItem"><a class="navItem" href="/docs/intersection-types">Intersection Types (T.all)</a></li><li class="navListItem"><a class="navItem" href="/docs/generics">Generics</a></li><li class="navListItem"><a class="navItem" href="/docs/non-forcing-constants">T::NonForcingConstants</a></li><li class="navListItem"><a class="navItem" href="/docs/strong">Banning untyped</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Editor Features</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/lsp">Language Server (LSP)</a></li><li class="navListItem"><a class="navItem" href="/docs/server-status">Server Status</a></li><li class="navListItem"><a class="navItem" href="/docs/lsp-typed-level">LSP &amp; Typed Level</a></li><li class="navListItem"><a class="navItem" href="/docs/go-to-def">Go to Definition</a></li><li class="navListItem"><a class="navItem" href="/docs/hover">Hover</a></li><li class="navListItem"><a class="navItem" href="/docs/autocompletion">Autocompletion</a></li><li class="navListItem"><a class="navItem" href="/docs/references">Find All References</a></li><li class="navListItem"><a class="navItem" href="/docs/code-actions">Code Actions</a></li><li class="navListItem"><a class="navItem" href="/docs/outline">Outline &amp; Document Symbols</a></li><li class="navListItem"><a class="navItem" href="/docs/doc-comments">Documentation Comments</a></li><li class="navListItem"><a class="navItem" href="/docs/sig-suggestion">Suggesting sigs</a></li><li class="navListItem"><a class="navItem" href="/docs/highlight-untyped">Highlighting untyped</a></li><li class="navListItem"><a class="navItem" href="/docs/sorbet-uris">sorbet: URIs</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Experimental Features</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/tuples">Tuples</a></li><li class="navListItem"><a class="navItem" href="/docs/shapes">Shapes</a></li><li class="navListItem"><a class="navItem" href="/docs/overloads">Overloads</a></li><li class="navListItem"><a class="navItem" href="/docs/requires-ancestor">Requiring Ancestors</a></li><li class="navListItem"><a class="navItem" href="/docs/rbs-support">RBS Comments</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://github.com/sorbet/sorbet/edit/master/website/docs/attached-class.md" target="_blank" rel="noreferrer noopener">Edit</a><h1 id="__docusaurus" class="postHeaderTitle">T.attached_class</h1></header><article><div><span><p><code>T.attached_class</code> can be used to refer to the type of instances from a singleton-context, in a way that is friendly to inheritance.</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoadableData</span></span>
  extend T::Sig

  sig { params(<span class="hljs-symbol">id:</span> Integer).returns(T.attached_class) }
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">load_by_id</span><span class="hljs-params">(id)</span></span>
    new
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Article</span> &lt; LoadableData;</span> <span class="hljs-keyword">end</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> &lt; LoadableData;</span> <span class="hljs-keyword">end</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Administrator</span> &lt; User;</span> <span class="hljs-keyword">end</span>

T.reveal_type(Article.load_by_id(<span class="hljs-number">10</span>)) <span class="hljs-comment"># Article</span>
T.reveal_type(User.load_by_id(<span class="hljs-number">15</span>)) <span class="hljs-comment"># User</span>
T.reveal_type(Administrator.load_by_id(<span class="hljs-number">20</span>)) <span class="hljs-comment"># Administrator</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="typing-factory-methods"></a><a href="#typing-factory-methods" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Typing factory methods</h2>
<p>Consider the following example of a class hierarchy with a factory method:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Parent</span></span>
  extend T::Sig

  <span class="hljs-comment"># Correct, but not ideal return type</span>
  sig { returns(Parent) }
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">make</span></span>
    new
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Child</span> &lt; Parent</span>
  sig { void }
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">say_hi</span></span>
    puts <span class="hljs-string">"hi"</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

T.reveal_type(Parent.make) <span class="hljs-comment"># Parent</span>
T.reveal_type(Child.make) <span class="hljs-comment"># Parent</span>

Child.make.say_hi <span class="hljs-comment"># Error: say_hi doesn't exist on Parent</span>
</code></pre>
<p><code>Parent</code> defines a single factory method <code>self.make</code>, which will create an instance of the <code>Parent</code> class. When this method is called off of the <code>Parent</code> class, it returns a new instance of type <code>Parent</code>. When it is called on <code>Child</code> it creates an instance of <code>Child</code> but the signature of <code>Parent.make</code> will cause the return value to be up-cast to <code>Parent</code>. This is fine if it’s convenient to use constructed <code>Child</code> values as though they were <code>Parent</code>, but becomes problematic if we need to call methods that are unique to <code>Child</code> instances, like in the case of <code>Child.make.say_hi</code>.</p>
<p>This is where <code>T.attached_class</code> comes in: changing the return type of <code>Parent.make</code> to <code>T.attached_class</code> indicates that it returns instances of the class the singleton method was called on. When called from <code>Parent</code>, it will return values of type <code>Parent</code>, and when called from <code>Child</code> it will return values of type <code>Child</code>. This resolves the type errors in the previous example with <code>Child.make.say_hi</code>,</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Parent</span></span>
  extend T::Sig

  sig { returns(T.attached_class) }
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">make</span></span>
    new
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Child</span> &lt; Parent</span>
  sig { void }
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">say_hi</span></span>
    puts <span class="hljs-string">"hi"</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

T.reveal_type(Parent.make) <span class="hljs-comment"># Parent</span>
T.reveal_type(Child.make) <span class="hljs-comment"># Child</span>

Child.make.say_hi <span class="hljs-comment"># No error now, as Child.make has the type Child</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="tattached_class-as-an-argument"></a><a href="#tattached_class-as-an-argument" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>T.attached_class</code> as an argument?</h2>
<p>Using <code>T.attached_class</code> as the type of parameters is an error in sorbet, and allowing it would cause soundness issues. To see why, let’s take a look at an example:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Parent</span></span>
  extend T::Sig

  sig { returns(T.attached_class) }
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">make</span></span>
    new
  <span class="hljs-keyword">end</span>

  sig { params(<span class="hljs-symbol">x:</span> T.attached_class).void } <span class="hljs-comment"># A bad type definition for `x`</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">consume</span><span class="hljs-params">(x)</span></span>
    puts <span class="hljs-string">"consumed"</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Child</span> &lt; Parent</span>
  extend T::Sig

  sig { void }
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">say_hi</span></span>
    puts <span class="hljs-string">"hi"</span>
  <span class="hljs-keyword">end</span>

  sig { params(<span class="hljs-symbol">x:</span> T.attached_class).void } <span class="hljs-comment"># A bad type definition for `x`</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">consume</span><span class="hljs-params">(x)</span></span>
    x.say_hi
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

Parent.consume(Parent.new)
Child.consume(Parent.new) <span class="hljs-comment"># We would like this to be an error</span>
</code></pre>
<p>Problems arise when you begin passing around singleton classes. Imagine that you write the method below, that accepts arguments of type <code>T.class_of(Parent)</code>.</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>
  extend T::Sig

  sig { params(<span class="hljs-symbol">cls:</span> T.class_of(Parent)).void }
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">consume_parent</span><span class="hljs-params">(cls)</span></span>
    cls.consume(Parent.make)
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>For the call to <code>cls.consume</code> in the body of <code>A.consume_parent</code>, we are always passing an argument whose type is <code>Parent</code>. Let’s walk through two different calls to <code>A.consume_parent</code>:</p>
<ul>
<li><code>A.consume_parent(Parent)</code>
<ul>
<li><code>Parent</code> has type <code>T.class_of(Parent)</code>, and is acceptable for <code>cls</code></li>
<li><code>Parent.consume</code> accepts values of type <code>Parent</code> (via <code>T.attached_class</code>)</li>
</ul></li>
<li><code>A.consume_parent(Child)</code>
<ul>
<li><code>Child</code> has type <code>T.class_of(Child)</code>, which is a subtype of <code>T.class_of(Parent)</code> and is acceptable for <code>cls</code></li>
<li><code>Child.consume</code> accepts arguments of type <code>Child</code> (via <code>T.attached_class</code>), and thus will raise an error when <code>say_hi</code> is called on the instance produced by <code>Parent.make</code></li>
</ul></li>
</ul>
<p>As these two cases show, Sorbet can’t know whether the body of <code>A.consume_parent</code> type checks or not without knowledge about what type <code>cls</code> is at runtime. Because of this problem, <code>T.attached_class</code> is only allowed to show up in the <code>returns</code> part of a signature, and if it does show up in the <code>params</code> of a signature, you’ll get an error:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Parent</span></span>
  extend T::Sig

  sig { params(<span class="hljs-symbol">x:</span> T.attached_class).void }
  <span class="hljs-comment">#            ^: T.attached_class may only be used in an :out context, like returns</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">problem</span><span class="hljs-params">(x)</span></span>; <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>As a final note: none of these problems would happen if <code>consume</code> were private:</p>
<ul>
<li>The bad call to <code>Child.consume(Parent.new)</code> would not be allowed, because <code>consume</code> would be private.</li>
<li>The bad call to <code>A.consume_parent(Child)</code> would not be allowed because the body of <code>consume_parent</code> contains <code>cls.consume</code>, which is a non-private call to a private method.</li>
</ul>
<p>As such, Sorbet allows <code>T.attached_class</code> to appear in input (<code>:in</code>) positions of private methods.</p>
<h2><a class="anchor" aria-hidden="true" id="tattached_class-common-problems"></a><a href="#tattached_class-common-problems" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>T.attached_class</code> common problems</h2>
<p>One common problem people encounter when using <code>T.attached_class</code> looks something like this:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-comment"># typed: true</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Parent</span></span>
  extend T::Sig

  sig { returns(T.attached_class) }
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">self</span>.<span class="hljs-title">make</span></span>
    Parent.new <span class="hljs-comment"># (1) Sorbet reports an error here</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Child</span> &lt; Parent;</span> <span class="hljs-keyword">end</span>

T.reveal_type(Child.make) <span class="hljs-comment"># Revealed type: `Child`</span>
</code></pre>
<p><a href="https://sorbet.run/#%23%20typed%3A%20true%0A%0Aclass%20Parent%0A%20%20extend%20T%3A%3ASig%0A%0A%20%20sig%20%7Breturns%28T.attached_class%29%7D%0A%20%20def%20self.make%0A%20%20%20%20Parent.new%0A%20%20end%0Aend%0A%0Aclass%20Child%20%3C%20Parent%3B%20end%0A%0AT.reveal_type%28Child.make%29%20%23%20reveals%20Child">→ View on sorbet.run</a></p>
<p>In this example, the program attempts to return <code>Parent.new</code> from <code>self.make</code>, instead of just <code>self.new</code>. There is a key difference: <code>Parent.new</code> will <strong>always</strong> make an instance of <code>Parent</code>, while <code>self.new</code> will make an instance of the particular subclass that <code>self.make</code> was called on.</p>
<p>For this reason, Sorbet has to report an error at comment <code>(1)</code> above. If we consider the <code>Child</code> class that inherits from <code>Parent</code>, the <code>T.attached_class</code> type suggests to the caller that <code>Child.make</code> will return a <code>Child</code> instance (the <code>T.reveal_type</code> confirms this).</p>
<p>Since <code>Parent.new</code> is not an instance of <code>Child</code> or any other potential subclasses of <code>Parent</code>, Sorbet must reject the code at <code>(1)</code>.</p>
<h2><a class="anchor" aria-hidden="true" id="has_attached_class-tattached_class-in-module-instance-methods"></a><a href="#has_attached_class-tattached_class-in-module-instance-methods" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>has_attached_class!</code>: <code>T.attached_class</code> in module instance methods</h2>
<p>Some modules are only ever eventually mixed into a <strong>class</strong> with <code>extend</code> (not <code>include</code>), meaning that any methods that module defines will eventually be called like singleton class methods.</p>
<p>These modules usually want to be able to call <code>new</code> to instantiate an instance of the class that the module is <code>extend</code>'d into. That’s a problem because normally constructor methods like that would have a return type of <code>T.attached_class</code>, but instance methods cannot mention <code>T.attached_class</code>.</p>
<p>To allow instance methods in such modules to use <code>T.attached_class</code>, Sorbet provides the <code>has_attached_class!</code> annotation:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">FinderMethods</span></span>
  extend T::Sig
  extend T::Generic
  abstract!

  has_attached_class!

  sig { abstract.returns(T.attached_class) }
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">new</span>;</span> <span class="hljs-keyword">end</span>

  sig { params(<span class="hljs-symbol">id:</span> String).returns(T.attached_class) }
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">find</span><span class="hljs-params">(id)</span></span>
    <span class="hljs-keyword">self</span>.new
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ParentModel</span></span>
  extend T::Sig
  extend FinderMethods
<span class="hljs-keyword">end</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChildModel</span> &lt; ParentModel</span>
<span class="hljs-keyword">end</span>

parent = ParentModel.find(<span class="hljs-string">'pa_123'</span>)
T.reveal_type(parent) <span class="hljs-comment"># =&gt; `ParentModel`</span>
child = ChildModel.find(<span class="hljs-string">'ch_123'</span>)
T.reveal_type(child)  <span class="hljs-comment"># =&gt; `ChildModel`</span>
</code></pre>
<p>Some things to note:</p>
<ul>
<li><p>The <code>has_attached_class!</code> method is exposed as a method in <code>T::Generic</code>, because using <code>has_attached_class!</code> implicitly makes the module into a <a href="/docs/generics">generic module</a>. This is why modules are not allowed to use <code>T.attached_class</code> by default. More on this in a moment.</p></li>
<li><p>We’ve declared <code>new</code> as an abstract method. This method is automatically detected to be implemented when <code>extend</code>'d into a class (because all classes inherit a concrete <code>self.new</code> method).</p>
<p>This abstract <code>new</code> method allows calling <code>new</code> in the <code>find</code> method. If this <code>find</code> method had been in an <a href="/docs/rbi">RBI file</a> (not in a source file), then the abstract <code>new</code> declaration would not have been required, because there would be no method bodies to type check.</p></li>
<li><p>The <code>FinderMethods</code> module is <code>extended</code> into <code>ParentModel</code>. Had this been <code>include FinderMethods</code>, Sorbet would have reported an error saying that <code>FinderMethods</code> can only be extended into classes.</p></li>
<li><p>The two calls to <code>find</code> at the bottom of the snippet reveal that <code>find</code>'s type changes based on the type of the method call’s receiver. Basically: <code>find</code> on a <code>ChildModel</code> will be a <code>ChildModel</code>.</p></li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="generics-and-has_attached_class"></a><a href="#generics-and-has_attached_class" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Generics and <code>has_attached_class!</code></h3>
<p>We mentioned above that using <code>has_attached_class!</code> in a module makes the module into a generic module. The mental model is to think of <code>has_attached_class!</code> as syntactic sugar for putting a <code>type_member</code> with an unknown name into the module. This <code>type_member</code>, having no explicit name, can then be referenced using <code>T.attached_class</code>.</p>
<p>What this means is that it’s possible to abstract over the attached class of an <code>has_attached_class!</code> module, the same as any other generic interface:</p>
<pre><code class="hljs css language-ruby">sig <span class="hljs-keyword">do</span>
  type_parameters(<span class="hljs-symbol">:U</span>)
    .params(
      <span class="hljs-symbol">findable:</span> FinderMethods[T.type_parameter(<span class="hljs-symbol">:U</span>)]
      <span class="hljs-symbol">id:</span> String
    )
    .returns(T.type_parameter(<span class="hljs-symbol">:U</span>))
<span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">find_and_log</span><span class="hljs-params">(findable, id)</span></span>
  instance = findable.find(id)
  puts(<span class="hljs-string">"Found <span class="hljs-subst">#{instance}</span>"</span>)
  instance
<span class="hljs-keyword">end</span>

parent = find_and_log(ParentModel, <span class="hljs-string">'pa_123'</span>)
T.reveal_type(parent) <span class="hljs-comment"># =&gt; `ParentModel`</span>
child = find_and_log(ChildModel, <span class="hljs-string">'pa_123'</span>)
T.reveal_type(child) <span class="hljs-comment"># =&gt; `ChildModel`</span>
</code></pre>
<p>Note how we’ve annotated the <code>findable</code> parameter as <code>FinderMethods[...]</code>, indicating that we’re using the <code>FinderMethods</code> module generically. In fact, supplying a type argument to the <code>FinderMethods</code> is now <strong>required</strong>: it’s not possible to reference <code>FinderMethods</code> in a type position without providing a type annotation. If you truly must ignore this, supply a type argument like <code>BasicObject</code> or <code>T.untyped</code> (or accept the autocorrect on the error, which will insert <code>T.untyped</code> by default).</p>
<p>As a generic, <code>has_attached_class!</code> takes the same arguments that <code>type_member</code> takes for things like variance and bounds:</p>
<pre><code class="hljs css language-ruby"><span class="hljs-comment"># Declares a covariant type member:</span>
has_attached_class!(<span class="hljs-symbol">:out</span>)

<span class="hljs-comment"># Places a bound on the type member:</span>
has_attached_class! { {<span class="hljs-symbol">upper:</span> SomeInterface} }

<span class="hljs-comment"># Altogether:</span>
has_attached_class!(<span class="hljs-symbol">:out</span>) { {<span class="hljs-symbol">upper:</span> SomeInterface} }
</code></pre>
<p>(Note that this type member cannot be declared contravariant, as that would make it impossible to mix this module into a class.)</p>
<blockquote>
<p>Note: you may also find this external blog post useful, which discusses similar topics:</p>
<p><a href="https://blog.jez.io/typing-klass-new/">Typing klass.new in Ruby with Sorbet →</a></p>
</blockquote>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/anything"><span class="arrow-prev">← </span><span>T.anything</span></a><a class="docs-next button" href="/docs/intersection-types"><span>Intersection Types (T.all)</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#typing-factory-methods">Typing factory methods</a></li><li><a href="#tattached_class-as-an-argument"><code>T.attached_class</code> as an argument?</a></li><li><a href="#tattached_class-common-problems"><code>T.attached_class</code> common problems</a></li><li><a href="#has_attached_class-tattached_class-in-module-instance-methods"><code>has_attached_class!</code>: <code>T.attached_class</code> in module instance methods</a><ul class="toc-headings"><li><a href="#generics-and-has_attached_class">Generics and <code>has_attached_class!</code></a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><div class="wrapper"><p class="footer"><svg width="99" height="28" viewBox="0 0 99 28" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.98432 20H6.27432C8.44932 20 9.81432 18.905 9.81432 17.03C9.81432 15.665 9.00432 14.72 7.78932 14.39C8.61432 14.105 9.45432 13.415 9.45432 12.035C9.45432 10.235 8.23932 9.23 5.95932 9.23H1.98432V20ZM3.37932 13.85V10.445H5.83932C7.27932 10.445 8.07432 11 8.07432 12.155C8.07432 13.295 7.27932 13.85 5.83932 13.85H3.37932ZM3.37932 15.08H6.21432C7.65432 15.08 8.43432 15.83 8.43432 16.925C8.43432 18.035 7.65432 18.785 6.21432 18.785H3.37932V15.08ZM18.0294 12.155H16.6794V16.88C16.6794 18.185 15.6894 18.92 14.7144 18.92C13.5594 18.92 13.0794 18.17 13.0794 17.06V12.155H11.7294V17.345C11.7294 19.01 12.6744 20.165 14.3544 20.165C15.4644 20.165 16.2294 19.58 16.6794 18.92V20H18.0294V12.155ZM20.5112 10.79H21.9812V9.23H20.5112V10.79ZM21.9212 12.155H20.5712V20H21.9212V12.155ZM25.8247 9.23H24.4747V20H25.8247V9.23ZM28.5882 18.125C28.5882 19.625 29.3532 20.075 30.6882 20.075C31.1382 20.075 31.5282 20.03 31.8732 19.955V18.8C31.5582 18.875 31.3332 18.89 31.0182 18.89C30.3282 18.89 29.9232 18.74 29.9232 17.915V13.31H31.7082V12.155H29.9232V9.86H28.5882V12.155H27.3732V13.31H28.5882V18.125ZM41.0199 20.165C43.1949 20.165 44.4399 18.305 44.4399 16.085C44.4399 13.85 43.1949 12.005 41.0199 12.005C39.9249 12.005 39.0549 12.53 38.5899 13.295V9.23H37.2399V20H38.5899V18.86C39.0549 19.64 39.9249 20.165 41.0199 20.165ZM38.5599 15.815C38.5599 13.985 39.6699 13.19 40.7799 13.19C42.2499 13.19 43.0749 14.39 43.0749 16.085C43.0749 17.765 42.2499 18.98 40.7799 18.98C39.6699 18.98 38.5599 18.17 38.5599 16.37V15.815ZM49.1804 20.855L52.5554 12.155H51.1454L48.9704 18.155L46.7654 12.155H45.3404L48.2504 19.715L47.8754 20.645C47.5604 21.425 47.2454 21.635 46.6604 21.635C46.4354 21.635 46.2704 21.62 46.0154 21.56V22.73C46.2554 22.775 46.4204 22.79 46.7504 22.79C48.1154 22.79 48.7304 22.04 49.1804 20.855Z" fill="white"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M98.7993 15.7838C98.7993 12.8786 97.3871 10.5862 94.688 10.5862C91.9774 10.5862 90.3374 12.8786 90.3374 15.7611C90.3374 19.177 92.2735 20.9019 95.0524 20.9019C96.4077 20.9019 97.4327 20.5955 98.2071 20.1643V17.8946C97.4327 18.2804 96.5443 18.5188 95.4168 18.5188C94.3121 18.5188 93.3327 18.1329 93.2074 16.7938H98.7766C98.7766 16.6463 98.7993 16.0561 98.7993 15.7838ZM93.1732 14.7057C93.1732 13.4233 93.9591 12.8899 94.6766 12.8899C95.3713 12.8899 96.1116 13.4233 96.1116 14.7057H93.1732Z" fill="white"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M85.9413 10.5862C84.8251 10.5862 84.1076 11.1082 83.709 11.4714L83.561 10.7678H81.0554V24.0001L83.9026 23.3986L83.914 20.187C84.324 20.482 84.9276 20.9019 85.9299 20.9019C87.9685 20.9019 89.8249 19.2678 89.8249 15.6703C89.8135 12.3792 87.9343 10.5862 85.9413 10.5862ZM85.2579 18.4053C84.586 18.4053 84.1874 18.167 83.914 17.8719L83.9026 13.6616C84.1988 13.3325 84.6088 13.1055 85.2579 13.1055C86.2943 13.1055 87.0118 14.2631 87.0118 15.7497C87.0118 17.2704 86.3057 18.4053 85.2579 18.4053Z" fill="white"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M77.1377 9.91656L79.9963 9.30374V7L77.1377 7.60147V9.91656Z" fill="white"></path><path d="M79.9963 10.7791H77.1377V20.709H79.9963V10.7791Z" fill="white"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M74.074 11.6187L73.8918 10.7789H71.4318V20.7088H74.279V13.9792C74.9509 13.1054 76.0898 13.2642 76.4429 13.3891V10.7789C76.0784 10.6427 74.7459 10.3931 74.074 11.6187Z" fill="white"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M68.3796 8.31641L65.6007 8.90653L65.5894 17.9966C65.5894 19.6762 66.8535 20.9132 68.5391 20.9132C69.473 20.9132 70.1563 20.743 70.5321 20.5387V18.235C70.1677 18.3825 68.3682 18.9045 68.3682 17.225V13.1962H70.5321V10.779H68.3682L68.3796 8.31641Z" fill="white"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M60.6807 13.6616C60.6807 13.219 61.0452 13.0488 61.6488 13.0488C62.5143 13.0488 63.6076 13.3098 64.4732 13.7751V11.1082C63.5279 10.7337 62.594 10.5862 61.6488 10.5862C59.3368 10.5862 57.7993 11.7891 57.7993 13.7978C57.7993 16.93 62.1271 16.4306 62.1271 17.7811C62.1271 18.3031 61.6715 18.4734 61.0338 18.4734C60.0885 18.4734 58.8813 18.0875 57.9246 17.5655V20.2664C58.9838 20.7204 60.0543 20.9133 61.0338 20.9133C63.4026 20.9133 65.0313 19.7444 65.0313 17.713C65.0199 14.3312 60.6807 14.9326 60.6807 13.6616Z" fill="white"></path></svg><a href="/docs/adopting">Get started</a> · <a href="/docs/overview">Docs</a> · <a href="https://sorbet.run">Try</a> · <a href="/en/community">Community</a> · <a href="/blog">Blog</a> · <a href="https://twitter.com/sorbet_ruby">Twitter</a></p></div><div id="csat-extension-config" data-notify="#sorbet-team"></div></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                appId: 'ZYWC6Z01G8',
                apiKey: 'b05a65e9f8d9f50dc4ec3241db8836c4',
                indexName: 'stripe_sorbet',
                inputSelector: '#search_input_react',
                algoliaOptions: {}
              });
            </script></body></html>